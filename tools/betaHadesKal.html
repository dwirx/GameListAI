<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Perolehan</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <!-- Cropperjs - untuk cropping gambar -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- MathJs for advanced calculations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div class="container mx-auto p-4 max-w-lg">
        <!-- Tab Navigation -->
        <div class="flex bg-white rounded-t-lg shadow-md mb-0">
            <button id="tab-calculator" class="tab-btn py-3 px-4 font-medium text-blue-600 border-b-2 border-blue-600 flex-1 flex items-center justify-center">
                <i class="fas fa-calculator mr-2"></i> Kalkulator
            </button>
            <button id="tab-chatbot" class="tab-btn py-3 px-4 font-medium text-gray-500 hover:text-gray-700 flex-1 flex items-center justify-center">
                <i class="fas fa-robot mr-2"></i> Chatbot
            </button>
        </div>

        <!-- Kalkulator Tab Content -->
        <div id="calculator-content" class="tab-content bg-white shadow-lg rounded-b-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Kalkulator Perolehan</h2>
                <div class="flex space-x-2">
                    <button id="scanBtn" class="text-sm bg-green-100 text-green-700 px-3 py-1 rounded-md hover:bg-green-200 transition">
                        <i class="fas fa-camera mr-1"></i> Scan
                    </button>
                    <button id="historyBtn" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-md hover:bg-blue-200 transition">
                        <i class="fas fa-history mr-1"></i> Riwayat
                    </button>
                    <button id="resetBtn" class="text-sm bg-red-100 text-red-700 px-3 py-1 rounded-md hover:bg-red-200 transition">
                        <i class="fas fa-trash-alt mr-1"></i> Reset
                    </button>
                </div>
            </div>
            
            <div class="space-y-4">
                <div class="input-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">SS Awal:</label>
                    <div class="relative">
                        <input type="text" id="ssAwal" placeholder="Contoh: 4.219.147.106" class="w-full px-3 py-2 pl-8 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="absolute left-3 top-2.5 text-gray-500"><i class="fas fa-coins"></i></span>
                    </div>
                </div>

                <div class="input-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Before Spend:</label>
                    <div class="relative">
                        <input type="text" id="beforeSpend" placeholder="Contoh: 4.219.147.106" class="w-full px-3 py-2 pl-8 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="absolute left-3 top-2.5 text-gray-500"><i class="fas fa-wallet"></i></span>
                    </div>
                </div>

                <div class="input-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">After Spend:</label>
                    <div class="relative">
                        <input type="text" id="afterSpend" placeholder="Contoh: 4.219.147.106" class="w-full px-3 py-2 pl-8 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="absolute left-3 top-2.5 text-gray-500"><i class="fas fa-wallet"></i></span>
                    </div>
                </div>

                <div class="input-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">SS Akhir:</label>
                    <div class="relative">
                        <input type="text" id="ssAkhir" placeholder="Contoh: 4.219.147.106" class="w-full px-3 py-2 pl-8 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="absolute left-3 top-2.5 text-gray-500"><i class="fas fa-coins"></i></span>
                    </div>
                </div>

                <div class="input-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Perolehan Sebelumnya:</label>
                    <div class="relative">
                        <input type="text" id="perolehanSebelumnya" placeholder="Contoh: 4.219.147.106" class="w-full px-3 py-2 pl-8 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="absolute left-3 top-2.5 text-gray-500"><i class="fas fa-chart-line"></i></span>
                    </div>
                </div>

                <button id="calculateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 mt-2 flex items-center justify-center">
                    <i class="fas fa-calculator mr-2"></i> Hitung
                </button>
            </div>

            <div class="mt-6 p-4 bg-gray-100 rounded-md shadow-inner" id="result">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-chart-bar mr-2 text-blue-600"></i> Hasil Perhitungan
                </h3>
                
                <div class="flex items-center justify-between py-2 border-b border-gray-200">
                    <span class="font-medium text-gray-700">Total Spend:</span>
                    <div class="flex items-center">
                        <span id="totalSpend" class="mr-2 text-lg font-semibold">0</span>
                        <button class="copy-btn bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded text-xs" 
                                onclick="copyToClipboard('totalSpend')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center justify-between py-2 border-b border-gray-200">
                    <span class="font-medium text-gray-700">Perolehan:</span>
                    <div class="flex items-center">
                        <span id="perolehan" class="mr-2 text-lg font-semibold">0</span>
                        <button class="copy-btn bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded text-xs" 
                                onclick="copyToClipboard('perolehan')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center justify-between py-2">
                    <span class="font-medium text-gray-700">Total Perolehan:</span>
                    <div class="flex items-center">
                        <span id="totalPerolehan" class="mr-2 text-xl font-bold text-blue-600">0</span>
                        <button class="copy-btn bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded text-xs" 
                                onclick="copyToClipboard('totalPerolehan')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-end">
                    <button id="saveHistoryBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-1.5 px-3 rounded-md text-sm transition duration-200 flex items-center">
                        <i class="fas fa-save mr-1"></i> Simpan ke Riwayat
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Chatbot Tab Content -->
        <div id="chatbot-content" class="tab-content bg-white shadow-lg rounded-b-lg p-6 hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">AI Assistant</h2>
                <div class="flex space-x-2">
                    <button id="clearChatBtn" class="text-sm bg-red-100 text-red-700 px-3 py-1 rounded-md hover:bg-red-200 transition">
                        <i class="fas fa-trash-alt mr-1"></i> Hapus Chat
                    </button>
                </div>
            </div>
            
            <div id="chat-container" class="bg-gray-50 border border-gray-200 rounded-lg h-96 overflow-y-auto p-4 mb-4">
                <div class="chat-message bot-message">
                    <div class="flex items-start mb-4">
                        <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white mr-2 flex-shrink-0">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-lg rounded-tl-none max-w-[85%]">
                            <p>Halo! Saya adalah AI Assistant Anda untuk membantu perhitungan dan menjawab pertanyaan. Anda dapat:</p>
                            <ul class="list-disc ml-5 mt-2">
                                <li>Melakukan perhitungan matematika (contoh: "hitung 2500 * 3 + 450")</li>
                                <li>Meminta saya menghitung perolehan (contoh: "hitung perolehan dengan SS awal 4000, before spend 5000, after spend 3000, SS akhir 5000")</li>
                                <li>Mengirim gambar untuk OCR (klik ikon kamera di bawah)</li>
                                <li>Atau bertanya tentang apa saja!</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="relative">
                <div class="flex items-center">
                    <button id="chatImageBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-l-lg">
                        <i class="fas fa-camera"></i>
                    </button>
                    <input type="text" id="chat-input" placeholder="Ketik pesan atau perhitungan..."
                        class="w-full border border-gray-300 rounded-r-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="send-btn" class="absolute right-2 top-2 bg-blue-600 text-white p-1.5 rounded-full hover:bg-blue-700">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <input type="file" id="chat-image-upload" class="hidden" accept="image/*">
            </div>
            
            <div class="flex flex-wrap items-center justify-center mt-4 gap-2 text-sm text-gray-700">
                <button class="quick-prompt px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full transition">Hitung 125 * 48</button>
                <button class="quick-prompt px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full transition">Berapa 15% dari 4.500.000?</button>
                <button class="quick-prompt px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full transition">Hitung perolehan</button>
            </div>
        </div>

        <!-- Modal Riwayat -->
        <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-bold text-gray-800">Riwayat Perhitungan</h3>
                    <button id="closeHistoryBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="overflow-y-auto p-4 flex-grow" id="historyList">
                    <!-- Riwayat akan dimasukkan di sini -->
                    <div class="text-center text-gray-500 py-8" id="emptyHistoryMessage">
                        <i class="fas fa-history text-4xl mb-3"></i>
                        <p>Belum ada riwayat perhitungan</p>
                    </div>
                </div>
                
                <div class="p-4 border-t flex justify-between">
                    <button id="clearHistoryBtn" class="bg-red-100 text-red-700 px-4 py-2 rounded-md hover:bg-red-200 transition flex items-center">
                        <i class="fas fa-trash-alt mr-1"></i> Hapus Semua
                    </button>
                    <button id="exportHistoryBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition flex items-center">
                        <i class="fas fa-download mr-1"></i> Export Data
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal Scan OCR -->
        <div id="scanModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-bold text-gray-800">Scan Angka dari Gambar</h3>
                    <button id="closeScanBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="p-4 flex-grow overflow-y-auto">
                    <div class="mb-4">
                        <div class="flex flex-wrap gap-2 items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Gambar:</label>
                            <div class="flex space-x-2">
                                <label for="imageUpload" class="cursor-pointer text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-md hover:bg-blue-200 transition flex items-center">
                                    <i class="fas fa-upload mr-1"></i> Upload
                                </label>
                                <button id="pasteBtnImage" class="text-sm bg-purple-100 text-purple-700 px-3 py-1 rounded-md hover:bg-purple-200 transition flex items-center">
                                    <i class="fas fa-paste mr-1"></i> Paste
                                </button>
                            </div>
                        </div>
                        <input type="file" id="imageUpload" accept="image/*" class="hidden">
                        <div class="mt-2 p-2 bg-gray-50 border border-dashed border-gray-300 rounded-md text-center text-sm text-gray-500" id="pasteArea">
                            <p>Paste gambar dengan Ctrl+V atau klik tombol Paste</p>
                        </div>
                    </div>
                    
                    <div class="mb-4 hidden" id="imagePreviewContainer">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Preview:</label>
                            <button id="cropImageBtn" class="text-sm bg-yellow-100 text-yellow-700 px-3 py-1 rounded-md hover:bg-yellow-200 transition flex items-center">
                                <i class="fas fa-crop-alt mr-1"></i> Crop
                            </button>
                        </div>
                        <div class="relative">
                            <div class="max-h-60 overflow-auto">
                                <img id="imagePreview" class="max-w-full h-auto rounded-md border border-gray-300" alt="Preview">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Container untuk Cropper.js -->
                    <div class="mb-4 hidden" id="cropContainer">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Crop Gambar:</label>
                            <div class="flex space-x-2">
                                <button id="applyCropBtn" class="text-sm bg-green-100 text-green-700 px-3 py-1 rounded-md hover:bg-green-200 transition flex items-center">
                                    <i class="fas fa-check mr-1"></i> Terapkan
                                </button>
                                <button id="cancelCropBtn" class="text-sm bg-red-100 text-red-700 px-3 py-1 rounded-md hover:bg-red-200 transition flex items-center">
                                    <i class="fas fa-times mr-1"></i> Batal
                                </button>
                            </div>
                        </div>
                        <div class="max-h-60 overflow-auto">
                            <img id="cropImage" class="max-w-full h-auto rounded-md border border-gray-300" alt="Crop">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Target Field:</label>
                        <select id="targetField" class="w-full py-2 px-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="ssAwal">SS Awal</option>
                            <option value="beforeSpend">Before Spend</option>
                            <option value="afterSpend">After Spend</option>
                            <option value="ssAkhir">SS Akhir</option>
                            <option value="perolehanSebelumnya">Perolehan Sebelumnya</option>
                        </select>
                    </div>
                    
                    <div id="scanResults" class="hidden space-y-2 mb-4">
                        <div class="p-3 bg-gray-100 rounded-md">
                            <h4 class="font-medium text-gray-800 mb-1">Hasil Scan:</h4>
                            <div id="extractedNumber" class="font-bold text-lg">-</div>
                        </div>
                    </div>
                    
                    <div id="scanLoading" class="hidden">
                        <div class="flex items-center justify-center space-x-2 my-4">
                            <div class="w-4 h-4 bg-blue-600 rounded-full animate-pulse"></div>
                            <div class="w-4 h-4 bg-blue-600 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-4 h-4 bg-blue-600 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                        <p class="text-center text-gray-600">Memproses gambar...</p>
                    </div>
                </div>
                
                <div class="p-4 border-t flex justify-end">
                    <button id="processImageBtn" disabled class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition flex items-center opacity-50">
                        <i class="fas fa-magic mr-1"></i> Proses Gambar
                    </button>
                    <button id="applyResultBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition flex items-center ml-2 hidden">
                        <i class="fas fa-check mr-1"></i> Terapkan
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal Chat OCR -->
        <div id="chatOcrModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-bold text-gray-800">Scan Gambar untuk Chat</h3>
                    <button id="closeChatOcrBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="p-4 flex-grow overflow-y-auto">
                    <div class="mb-4">
                        <div class="flex flex-wrap gap-2 items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Gambar:</label>
                            <div class="flex space-x-2">
                                <label for="chatImageUpload" class="cursor-pointer text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-md hover:bg-blue-200 transition flex items-center">
                                    <i class="fas fa-upload mr-1"></i> Upload
                                </label>
                                <button id="chatPasteBtnImage" class="text-sm bg-purple-100 text-purple-700 px-3 py-1 rounded-md hover:bg-purple-200 transition flex items-center">
                                    <i class="fas fa-paste mr-1"></i> Paste
                                </button>
                            </div>
                        </div>
                        <input type="file" id="chatImageUpload" accept="image/*" class="hidden">
                        <div class="mt-2 p-2 bg-gray-50 border border-dashed border-gray-300 rounded-md text-center text-sm text-gray-500" id="chatPasteArea">
                            <p>Paste gambar dengan Ctrl+V atau klik tombol Paste</p>
                        </div>
                    </div>
                    
                    <div class="mb-4 hidden" id="chatImagePreviewContainer">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Preview:</label>
                            <button id="chatCropImageBtn" class="text-sm bg-yellow-100 text-yellow-700 px-3 py-1 rounded-md hover:bg-yellow-200 transition flex items-center">
                                <i class="fas fa-crop-alt mr-1"></i> Crop
                            </button>
                        </div>
                        <div class="relative">
                            <div class="max-h-60 overflow-auto">
                                <img id="chatImagePreview" class="max-w-full h-auto rounded-md border border-gray-300" alt="Preview">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Container untuk Cropper.js di Chat -->
                    <div class="mb-4 hidden" id="chatCropContainer">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Crop Gambar:</label>
                            <div class="flex space-x-2">
                                <button id="chatApplyCropBtn" class="text-sm bg-green-100 text-green-700 px-3 py-1 rounded-md hover:bg-green-200 transition flex items-center">
                                    <i class="fas fa-check mr-1"></i> Terapkan
                                </button>
                                <button id="chatCancelCropBtn" class="text-sm bg-red-100 text-red-700 px-3 py-1 rounded-md hover:bg-red-200 transition flex items-center">
                                    <i class="fas fa-times mr-1"></i> Batal
                                </button>
                            </div>
                        </div>
                        <div class="max-h-60 overflow-auto">
                            <img id="chatCropImage" class="max-w-full h-auto rounded-md border border-gray-300" alt="Crop">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Instruksi (opsional):</label>
                        <textarea id="chat-image-instruction" placeholder="Tambahkan instruksi untuk gambar ini, contoh: 'Ekstrak semua angka'"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 h-20"></textarea>
                    </div>
                </div>
                
                <div class="p-4 border-t flex justify-end">
                    <button id="sendChatImageBtn" disabled class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition flex items-center opacity-50">
                        <i class="fas fa-paper-plane mr-1"></i> Kirim ke Chat
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Toast Notifikasi -->
        <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-10 opacity-0 transition-all duration-300 z-50">
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span id="toastMessage">Berhasil disimpan!</span>
            </div>
        </div>
        
        <div class="text-center text-gray-500 text-sm mt-4">
            Â© 2025 Kalkulator Perolehan - Semua data disimpan secara lokal di perangkat Anda
        </div>
    </div>

    <script>
        // Struktur data untuk menyimpan riwayat
        let calculationHistory = [];
        
        // Nilai yang diekstrak dari OCR
        let extractedValue = null;
        
        // Variabel untuk cropper
        let cropper = null;
        let chatCropper = null;
        
        // API Key untuk Google Gemini
        const GEMINI_API_KEY = "AIzaSyC7UZC9dg915QDQ5WlDnqca7_2IRIE3WJc";
        
        // Menyimpan chat history
        let chatHistory = [];
        
        // Tab handling
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all tabs
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                    btn.classList.add('text-gray-500', 'hover:text-gray-700');
                });
                
                // Add active class to clicked tab
                button.classList.remove('text-gray-500', 'hover:text-gray-700');
                button.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                
                // Hide all content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Show appropriate content
                const contentId = button.id.replace('tab-', '') + '-content';
                document.getElementById(contentId).classList.remove('hidden');
            });
        });
        
        // Fungsi untuk mengonversi string dengan format angka Indonesia ke number
        function parseIDNumber(strNumber) {
            if (!strNumber) return 0;
            // Menghapus semua titik sebagai pemisah ribuan
            const cleanedNumber = strNumber.replace(/\./g, '');
            return parseFloat(cleanedNumber) || 0;
        }

        // Fungsi untuk memformat tampilan input dengan titik sebagai pemisah ribuan
        function formatNumberInput(inputElement) {
            inputElement.addEventListener('input', function(e) {
                // Simpan posisi kursor
                const start = this.selectionStart;
                const end = this.selectionEnd;
                const valueLength = this.value.length;
                
                // Hapus semua karakter kecuali angka
                let value = this.value.replace(/[^\d]/g, '');
                
                // Format angka dengan titik sebagai pemisah ribuan
                if (value) {
                    this.value = new Intl.NumberFormat('id-ID').format(parseInt(value)).replace(/,/g, '.');
                } else {
                    this.value = '';
                }
                
                // Menyimpan ke localStorage
                saveInputToLocalStorage();
                
                // Mengatur ulang posisi kursor dengan mempertimbangkan perbedaan panjang string
                const newLength = this.value.length;
                const diff = newLength - valueLength;
                this.setSelectionRange(start + diff, end + diff);
            });
        }

        // Fungsi untuk menyimpan input ke localStorage
        function saveInputToLocalStorage() {
            const data = {
                ssAwal: document.getElementById('ssAwal').value,
                beforeSpend: document.getElementById('beforeSpend').value,
                afterSpend: document.getElementById('afterSpend').value,
                ssAkhir: document.getElementById('ssAkhir').value,
                perolehanSebelumnya: document.getElementById('perolehanSebelumnya').value,
                totalSpend: document.getElementById('totalSpend').textContent,
                perolehan: document.getElementById('perolehan').textContent,
                totalPerolehan: document.getElementById('totalPerolehan').textContent
            };
            
            localStorage.setItem('kalkulatorPerolehanData', JSON.stringify(data));
        }

        // Fungsi untuk memuat data dari localStorage
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('kalkulatorPerolehanData');
            if (savedData) {
                const data = JSON.parse(savedData);
                
                document.getElementById('ssAwal').value = data.ssAwal || '';
                document.getElementById('beforeSpend').value = data.beforeSpend || '';
                document.getElementById('afterSpend').value = data.afterSpend || '';
                document.getElementById('ssAkhir').value = data.ssAkhir || '';
                document.getElementById('perolehanSebelumnya').value = data.perolehanSebelumnya || '';
                
                document.getElementById('totalSpend').textContent = data.totalSpend || '0';
                document.getElementById('perolehan').textContent = data.perolehan || '0';
                document.getElementById('totalPerolehan').textContent = data.totalPerolehan || '0';
            }
            
            // Memuat riwayat perhitungan
            const savedHistory = localStorage.getItem('kalkulatorPerolehanHistory');
            if (savedHistory) {
                calculationHistory = JSON.parse(savedHistory);
            }
            
            // Memuat chat history
            const savedChat = localStorage.getItem('kalkulatorPerolehanChat');
            if (savedChat) {
                chatHistory = JSON.parse(savedChat);
                renderChatHistory();
            }
        }

        // Fungsi untuk menampilkan toast notifikasi
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            
            toast.classList.remove('translate-y-10', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                toast.classList.remove('translate-y-0', 'opacity-100');
            }, 3000);
        }

        // Fungsi untuk menyimpan perhitungan ke riwayat
        function saveToHistory() {
            const ssAwal = document.getElementById('ssAwal').value;
            const beforeSpend = document.getElementById('beforeSpend').value;
            const afterSpend = document.getElementById('afterSpend').value;
            const ssAkhir = document.getElementById('ssAkhir').value;
            const perolehanSebelumnya = document.getElementById('perolehanSebelumnya').value;
            const totalSpend = document.getElementById('totalSpend').textContent;
            const perolehan = document.getElementById('perolehan').textContent;
            const totalPerolehan = document.getElementById('totalPerolehan').textContent;

            // Buat entri riwayat baru
            const historyEntry = {
                id: Date.now(),
                date: new Date().toLocaleString('id-ID'),
                data: {
                    ssAwal,
                    beforeSpend,
                    afterSpend,
                    ssAkhir,
                    perolehanSebelumnya,
                    totalSpend,
                    perolehan,
                    totalPerolehan
                }
            };

            // Tambahkan ke array riwayat
            calculationHistory.unshift(historyEntry);
            
            // Batasi jumlah riwayat (opsional)
            if (calculationHistory.length > 50) {
                calculationHistory = calculationHistory.slice(0, 50);
            }
            
            // Simpan ke localStorage
            localStorage.setItem('kalkulatorPerolehanHistory', JSON.stringify(calculationHistory));
            
            // Tampilkan notifikasi
            showToast('Perhitungan berhasil disimpan ke riwayat');
            
            // Perbarui tampilan riwayat jika sedang terbuka
            if (!document.getElementById('historyModal').classList.contains('hidden')) {
                renderHistoryList();
            }
        }

        // Fungsi untuk menampilkan daftar riwayat
        function renderHistoryList() {
            const historyListElement = document.getElementById('historyList');
            const emptyHistoryMessage = document.getElementById('emptyHistoryMessage');
            
            // Kosongkan konten saat ini kecuali pesan 'kosong'
            while (historyListElement.firstChild && historyListElement.firstChild !== emptyHistoryMessage) {
                historyListElement.removeChild(historyListElement.firstChild);
            }
            
            if (calculationHistory.length === 0) {
                emptyHistoryMessage.classList.remove('hidden');
                return;
            }
            
            emptyHistoryMessage.classList.add('hidden');
            
            // Render setiap item riwayat
            calculationHistory.forEach((entry) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'bg-white p-3 rounded-lg shadow mb-3 border border-gray-200';
                historyItem.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-xs text-gray-500">${entry.date}</span>
                            <h4 class="font-semibold text-gray-800">Total Perolehan: ${entry.data.totalPerolehan}</h4>
                        </div>
                        <div class="flex space-x-1">
                            <button class="load-history-btn bg-blue-100 hover:bg-blue-200 text-blue-700 p-1 rounded" 
                                    data-id="${entry.id}" title="Muat data">
                                <i class="fas fa-redo-alt"></i>
                            </button>
                            <button class="delete-history-btn bg-red-100 hover:bg-red-200 text-red-700 p-1 rounded" 
                                    data-id="${entry.id}" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="text-gray-600">SS Awal: <span class="font-medium">${entry.data.ssAwal || '0'}</span></div>
                        <div class="text-gray-600">Before Spend: <span class="font-medium">${entry.data.beforeSpend || '0'}</span></div>
                        <div class="text-gray-600">After Spend: <span class="font-medium">${entry.data.afterSpend || '0'}</span></div>
                        <div class="text-gray-600">SS Akhir: <span class="font-medium">${entry.data.ssAkhir || '0'}</span></div>
                        <div class="text-gray-600">Total Spend: <span class="font-medium">${entry.data.totalSpend}</span></div>
                        <div class="text-gray-600">Perolehan: <span class="font-medium">${entry.data.perolehan}</span></div>
                    </div>
                `;
                
                historyListElement.appendChild(historyItem);
            });
            
            // Tambahkan event listeners untuk tombol-tombol
            document.querySelectorAll('.load-history-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    loadHistoryItem(id);
                });
            });
            
            document.querySelectorAll('.delete-history-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteHistoryItem(id);
                });
            });
        }

        // Fungsi untuk memuat data dari item riwayat
        function loadHistoryItem(id) {
            const entry = calculationHistory.find(item => item.id === id);
            if (!entry) return;
            
            document.getElementById('ssAwal').value = entry.data.ssAwal;
            document.getElementById('beforeSpend').value = entry.data.beforeSpend;
            document.getElementById('afterSpend').value = entry.data.afterSpend;
            document.getElementById('ssAkhir').value = entry.data.ssAkhir;
            document.getElementById('perolehanSebelumnya').value = entry.data.perolehanSebelumnya;
            
            document.getElementById('totalSpend').textContent = entry.data.totalSpend;
            document.getElementById('perolehan').textContent = entry.data.perolehan;
            document.getElementById('totalPerolehan').textContent = entry.data.totalPerolehan;
            
            // Simpan ke localStorage
            saveInputToLocalStorage();
            
            // Tutup modal riwayat
            document.getElementById('historyModal').classList.add('hidden');
            
            // Tampilkan notifikasi
            showToast('Data riwayat berhasil dimuat');
        }

        // Fungsi untuk menghapus item riwayat
        function deleteHistoryItem(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                calculationHistory = calculationHistory.filter(item => item.id !== id);
                localStorage.setItem('kalkulatorPerolehanHistory', JSON.stringify(calculationHistory));
                renderHistoryList();
                showToast('Data riwayat berhasil dihapus');
            }
        }

        // Fungsi untuk mengekspor riwayat
        function exportHistory() {
            if (calculationHistory.length === 0) {
                alert('Tidak ada data riwayat untuk diekspor');
                return;
            }
            
            // Format data untuk ekspor
            let csvContent = 'data:text/csv;charset=utf-8,';
            csvContent += 'Tanggal,SS Awal,Before Spend,After Spend,SS Akhir,Perolehan Sebelumnya,Total Spend,Perolehan,Total Perolehan\n';
            
            calculationHistory.forEach(entry => {
                const row = [
                    entry.date,
                    entry.data.ssAwal.replace(/\./g, ''),
                    entry.data.beforeSpend.replace(/\./g, ''),
                    entry.data.afterSpend.replace(/\./g, ''),
                    entry.data.ssAkhir.replace(/\./g, ''),
                    entry.data.perolehanSebelumnya.replace(/\./g, ''),
                    entry.data.totalSpend.replace(/\./g, ''),
                    entry.data.perolehan.replace(/\./g, ''),
                    entry.data.totalPerolehan.replace(/\./g, '')
                ].join(',');
                csvContent += row + '\n';
            });
            
            // Buat link untuk download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `perhitungan_perolehan_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Fungsi untuk memproses gambar dari clipboard
        function handlePastedImage(event) {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        // Tampilkan preview gambar
                        document.getElementById('imagePreview').src = e.target.result;
                        document.getElementById('imagePreviewContainer').classList.remove('hidden');
                        
                        // Aktifkan tombol proses
                        document.getElementById('processImageBtn').disabled = false;
                        document.getElementById('processImageBtn').classList.remove('opacity-50');
                        
                        // Sembunyikan hasil sebelumnya
                        document.getElementById('scanResults').classList.add('hidden');
                        document.getElementById('applyResultBtn').classList.add('hidden');
                    };
                    
                    reader.readAsDataURL(blob);
                    break;
                }
            }
        }
        
        // Fungsi untuk memproses gambar dari clipboard (untuk chat)
        function handleChatPastedImage(event) {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        // Tampilkan preview gambar
                        document.getElementById('chatImagePreview').src = e.target.result;
                        document.getElementById('chatImagePreviewContainer').classList.remove('hidden');
                        
                        // Aktifkan tombol proses
                        document.getElementById('sendChatImageBtn').disabled = false;
                        document.getElementById('sendChatImageBtn').classList.remove('opacity-50');
                    };
                    
                    reader.readAsDataURL(blob);
                    break;
                }
            }
        }
        
        // Fungsi untuk mengatur cropper pada gambar
        function setupCropper() {
            // Sembunyikan preview container dan tampilkan crop container
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            document.getElementById('cropContainer').classList.remove('hidden');
            
            // Clone gambar preview ke crop image
            const imgSrc = document.getElementById('imagePreview').src;
            const cropImage = document.getElementById('cropImage');
            cropImage.src = imgSrc;
            
            // Inisialisasi cropper
            if (cropper) {
                cropper.destroy();
            }
            
            cropper = new Cropper(cropImage, {
                aspectRatio: NaN,
                viewMode: 1,
                autoCropArea: 0.8,
                responsive: true,
                guides: true,
                highlight: true,
                cropBoxResizable: true
            });
        }
        
        // Fungsi untuk mengatur cropper pada gambar chat
        function setupChatCropper() {
            // Sembunyikan preview container dan tampilkan crop container
            document.getElementById('chatImagePreviewContainer').classList.add('hidden');
            document.getElementById('chatCropContainer').classList.remove('hidden');
            
            // Clone gambar preview ke crop image
            const imgSrc = document.getElementById('chatImagePreview').src;
            const cropImage = document.getElementById('chatCropImage');
            cropImage.src = imgSrc;
            
            // Inisialisasi cropper
            if (chatCropper) {
                chatCropper.destroy();
            }
            
            chatCropper = new Cropper(cropImage, {
                aspectRatio: NaN,
                viewMode: 1,
                autoCropArea: 0.8,
                responsive: true,
                guides: true,
                highlight: true,
                cropBoxResizable: true
            });
        }
        
        // Fungsi untuk menerapkan crop pada gambar
        function applyCrop() {
            if (!cropper) return;
            
            // Dapatkan hasil crop
            const canvas = cropper.getCroppedCanvas({
                maxWidth: 1920,
                maxHeight: 1080,
                fillColor: '#fff'
            });
            
            if (!canvas) return;
            
            // Konversi canvas ke data URL
            const croppedImageUrl = canvas.toDataURL('image/jpeg');
            
            // Tampilkan hasil crop
            document.getElementById('imagePreview').src = croppedImageUrl;
            document.getElementById('imagePreviewContainer').classList.remove('hidden');
            document.getElementById('cropContainer').classList.add('hidden');
            
            // Hancurkan instance cropper
            cropper.destroy();
            cropper = null;
        }
        
        // Fungsi untuk menerapkan crop pada gambar chat
        function applyChatCrop() {
            if (!chatCropper) return;
            
            // Dapatkan hasil crop
            const canvas = chatCropper.getCroppedCanvas({
                maxWidth: 1920,
                maxHeight: 1080,
                fillColor: '#fff'
            });
            
            if (!canvas) return;
            
            // Konversi canvas ke data URL
            const croppedImageUrl = canvas.toDataURL('image/jpeg');
            
            // Tampilkan hasil crop
            document.getElementById('chatImagePreview').src = croppedImageUrl;
            document.getElementById('chatImagePreviewContainer').classList.remove('hidden');
            document.getElementById('chatCropContainer').classList.add('hidden');
            
            // Hancurkan instance cropper
            chatCropper.destroy();
            chatCropper = null;
        }
        
        // Fungsi untuk membatalkan crop
        function cancelCrop() {
            document.getElementById('imagePreviewContainer').classList.remove('hidden');
            document.getElementById('cropContainer').classList.add('hidden');
            
            // Hancurkan instance cropper
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }
        
        // Fungsi untuk membatalkan crop pada chat
        function cancelChatCrop() {
            document.getElementById('chatImagePreviewContainer').classList.remove('hidden');
            document.getElementById('chatCropContainer').classList.add('hidden');
            
            // Hancurkan instance cropper
            if (chatCropper) {
                chatCropper.destroy();
                chatCropper = null;
            }
        }
        
        // Fungsi untuk ekstrak teks dari gambar menggunakan Google Gemini API
        async function extractTextFromImage(imageFile) {
            try {
                // Menunjukkan loading
                document.getElementById('scanLoading').classList.remove('hidden');
                document.getElementById('scanResults').classList.add('hidden');
                document.getElementById('applyResultBtn').classList.add('hidden');
                
                // Konversi gambar ke base64
                const base64Image = await fileToBase64(imageFile);
                
                // Buat request ke Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            role: 'user',
                            parts: [
                                {
                                    inlineData: {
                                        mimeType: 'image/jpeg',
                                        data: base64Image.split(',')[1]
                                    }
                                },
                                {
                                    text: 'Ekstrak semua angka yang ada di gambar ini. Hanya berikan angkanya saja tanpa penjelasan apapun. Jika ada beberapa angka, pilih angka terbesar. Format angka tanpa pemisah ribuan (titik atau koma). Contoh hasil yang diharapkan: 4219147106'
                                }
                            ]
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to extract text from image');
                }
                
                const data = await response.json();
                
                // Sembunyikan loading
                document.getElementById('scanLoading').classList.add('hidden');
                
                // Ekstrak teks dari respons
                let extractedText = '';
                if (data.candidates && data.candidates.length > 0 && 
                    data.candidates[0].content && data.candidates[0].content.parts) {
                    extractedText = data.candidates[0].content.parts[0].text.trim();
                }
                
                // Hapus karakter non-numerik dan spasi
                extractedText = extractedText.replace(/\D/g, '');
                
                if (extractedText) {
                    // Format angka dengan titik sebagai pemisah ribuan
                    const formattedNumber = new Intl.NumberFormat('id-ID').format(parseInt(extractedText)).replace(/,/g, '.');
                    extractedValue = formattedNumber;
                    
                    // Tampilkan hasil
                    document.getElementById('extractedNumber').textContent = formattedNumber;
                    document.getElementById('scanResults').classList.remove('hidden');
                    document.getElementById('applyResultBtn').classList.remove('hidden');
                    
                    return formattedNumber;
                } else {
                    document.getElementById('extractedNumber').textContent = 'Tidak dapat mendeteksi angka';
                    document.getElementById('scanResults').classList.remove('hidden');
                    return null;
                }
            } catch (error) {
                console.error('Error extracting text:', error);
                document.getElementById('scanLoading').classList.add('hidden');
                document.getElementById('extractedNumber').textContent = 'Error: ' + error.message;
                document.getElementById('scanResults').classList.remove('hidden');
                return null;
            }
        }
        
        // Fungsi untuk mengkonversi file ke base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // Fungsi untuk mendapatkan blob dari data URL
        function dataURLtoBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            
            return new Blob([u8arr], { type: mime });
        }

        // Untuk perhitungan dan pemformatan
        function calculate() {
            // Mengambil nilai input dan mengonversinya
            const ssAwal = parseIDNumber(document.getElementById('ssAwal').value);
            const beforeSpend = parseIDNumber(document.getElementById('beforeSpend').value);
            const afterSpend = parseIDNumber(document.getElementById('afterSpend').value);
            const ssAkhir = parseIDNumber(document.getElementById('ssAkhir').value);
            const perolehanSebelumnya = parseIDNumber(document.getElementById('perolehanSebelumnya').value);

            // Menghitung total spend
            const totalSpend = beforeSpend - afterSpend;

            // Menghitung perolehan
            const perolehan = (ssAkhir - ssAwal) + (beforeSpend - afterSpend);

            // Menghitung total perolehan
            const totalPerolehan = perolehan + perolehanSebelumnya;

            // Menampilkan hasil dengan format angka Indonesia (menggunakan titik sebagai pemisah ribuan)
            document.getElementById('totalSpend').textContent = new Intl.NumberFormat('id-ID').format(totalSpend).replace(/,/g, '.');
            document.getElementById('perolehan').textContent = new Intl.NumberFormat('id-ID').format(perolehan).replace(/,/g, '.');
            document.getElementById('totalPerolehan').textContent = new Intl.NumberFormat('id-ID').format(totalPerolehan).replace(/,/g, '.');
            
            // Simpan hasil ke localStorage
            saveInputToLocalStorage();
            
            // Animasi hasil
            const resultElement = document.getElementById('result');
            resultElement.classList.add('bg-green-50');
            setTimeout(() => {
                resultElement.classList.remove('bg-green-50');
            }, 500);
            
            // Tampilkan notifikasi
            showToast('Perhitungan berhasil');
            
            return {
                ssAwal,
                beforeSpend,
                afterSpend,
                ssAkhir,
                perolehanSebelumnya,
                totalSpend,
                perolehan,
                totalPerolehan
            };
        }

        // Fungsi untuk perhitungan pada chatbot
        function chatCalculate(ssAwal, beforeSpend, afterSpend, ssAkhir, perolehanSebelumnya = 0) {
            // Menghitung total spend
            const totalSpend = beforeSpend - afterSpend;

            // Menghitung perolehan
            const perolehan = (ssAkhir - ssAwal) + totalSpend;

            // Menghitung total perolehan
            const totalPerolehan = perolehan + perolehanSebelumnya;
            
            return {
                totalSpend,
                perolehan,
                totalPerolehan
            };
        }
        
        // Fungsi untuk menambahkan pesan ke chat
        function addMessageToChat(sender, message, isImage = false) {
            const chatContainer = document.getElementById('chat-container');
            const messageElement = document.createElement('div');
            
            if (sender === 'user') {
                messageElement.className = 'chat-message user-message';
                if (isImage) {
                    messageElement.innerHTML = `
                        <div class="flex items-start justify-end mb-4">
                            <div class="bg-blue-600 p-3 rounded-lg rounded-tr-none max-w-[85%]">
                                <img src="${message}" class="max-w-full rounded" alt="User Image">
                            </div>
                            <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white ml-2 flex-shrink-0">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                    `;
                } else {
                    messageElement.innerHTML = `
                        <div class="flex items-start justify-end mb-4">
                            <div class="bg-blue-600 p-3 rounded-lg rounded-tr-none text-white max-w-[85%]">
                                <p>${message}</p>
                            </div>
                            <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white ml-2 flex-shrink-0">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                    `;
                }
            } else {
                messageElement.className = 'chat-message bot-message';
                messageElement.innerHTML = `
                    <div class="flex items-start mb-4">
                        <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white mr-2 flex-shrink-0">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-lg rounded-tl-none max-w-[85%]">
                            <p>${message}</p>
                        </div>
                    </div>
                `;
            }
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Tambahkan ke chat history
            const chatEntry = {
                sender,
                message,
                isImage,
                timestamp: new Date().toISOString()
            };
            
            chatHistory.push(chatEntry);
            saveChatHistory();
        }
        
        // Tampilkan loading di chat
        function showChatLoading() {
            const chatContainer = document.getElementById('chat-container');
            const loadingElement = document.createElement('div');
            loadingElement.id = 'chat-loading';
            loadingElement.className = 'chat-message bot-message';
            loadingElement.innerHTML = `
                <div class="flex items-start mb-4">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white mr-2 flex-shrink-0">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg rounded-tl-none max-w-[85%]">
                        <div class="flex space-x-2">
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(loadingElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Sembunyikan loading di chat
        function hideChatLoading() {
            const loadingElement = document.getElementById('chat-loading');
            if (loadingElement) {
                loadingElement.remove();
            }
        }
        
        // Fungsi untuk menyimpan chat history ke localStorage
        function saveChatHistory() {
            localStorage.setItem('kalkulatorPerolehanChat', JSON.stringify(chatHistory));
        }
        
        // Fungsi untuk menampilkan chat history
        function renderChatHistory() {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '';
            
            chatHistory.forEach(entry => {
                const messageElement = document.createElement('div');
                
                if (entry.sender === 'user') {
                    messageElement.className = 'chat-message user-message';
                    if (entry.isImage) {
                        messageElement.innerHTML = `
                            <div class="flex items-start justify-end mb-4">
                                <div class="bg-blue-600 p-3 rounded-lg rounded-tr-none max-w-[85%]">
                                    <img src="${entry.message}" class="max-w-full rounded" alt="User Image">
                                </div>
                                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white ml-2 flex-shrink-0">
                                    <i class="fas fa-user"></i>
                                </div>
                            </div>
                        `;
                    } else {
                        messageElement.innerHTML = `
                            <div class="flex items-start justify-end mb-4">
                                <div class="bg-blue-600 p-3 rounded-lg rounded-tr-none text-white max-w-[85%]">
                                    <p>${entry.message}</p>
                                </div>
                                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white ml-2 flex-shrink-0">
                                    <i class="fas fa-user"></i>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    messageElement.className = 'chat-message bot-message';
                    messageElement.innerHTML = `
                        <div class="flex items-start mb-4">
                            <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white mr-2 flex-shrink-0">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-lg rounded-tl-none max-w-[85%]">
                                <p>${entry.message}</p>
                            </div>
                        </div>
                    `;
                }
                
                chatContainer.appendChild(messageElement);
            });
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Fungsi untuk mengirim pesan dari chat input
        function sendChatMessage() {
            const inputElement = document.getElementById('chat-input');
            const message = inputElement.value.trim();
            
            if (message === '') return;
            
            // Tampilkan pesan pengguna
            addMessageToChat('user', message);
            
            // Clear input
            inputElement.value = '';
            
            // Tampilkan loading
            showChatLoading();
            
            // Proses pesan
            processChatMessage(message);
        }
        
        // Fungsi untuk mengirim gambar dari chat
        async function sendChatImage() {
            const imagePreview = document.getElementById('chatImagePreview');
            const instruction = document.getElementById('chat-image-instruction').value.trim();
            
            if (!imagePreview.src) {
                alert('Silakan pilih gambar terlebih dahulu');
                return;
            }
            
            // Tambahkan gambar ke chat
            addMessageToChat('user', imagePreview.src, true);
            
            // Tambahkan instruksi jika ada
            if (instruction) {
                addMessageToChat('user', instruction);
            }
            
            // Tutup modal
            document.getElementById('chatOcrModal').classList.add('hidden');
            
            // Reset modal
            document.getElementById('chat-image-instruction').value = '';
            document.getElementById('chatImagePreviewContainer').classList.add('hidden');
            
            // Tampilkan loading
            showChatLoading();
            
            // Proses gambar
            try {
                // Konversi gambar ke blob
                const imageBlob = dataURLtoBlob(imagePreview.src);
                
                // Konversi ke base64
                const base64Image = await fileToBase64(imageBlob);
                
                // Buat request ke Gemini API
                const promptText = instruction || 'Analisis gambar ini dan jelaskan apa yang ada di dalamnya secara detail. Jika ada angka, ekstrak dan sebutkan angka tersebut.';
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            role: 'user',
                            parts: [
                                {
                                    inlineData: {
                                        mimeType: 'image/jpeg',
                                        data: base64Image.split(',')[1]
                                    }
                                },
                                {
                                    text: promptText
                                }
                            ]
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to process image');
                }
                
                const data = await response.json();
                
                // Ekstrak teks dari respons
                let botResponse = 'Maaf, saya tidak dapat menganalisis gambar tersebut.';
                if (data.candidates && data.candidates.length > 0 && 
                    data.candidates[0].content && data.candidates[0].content.parts) {
                    botResponse = data.candidates[0].content.parts[0].text;
                }
                
                // Sembunyikan loading
                hideChatLoading();
                
                // Tampilkan respons
                addMessageToChat('bot', botResponse);
                
            } catch (error) {
                console.error('Error processing image:', error);
                hideChatLoading();
                addMessageToChat('bot', 'Maaf, terjadi kesalahan saat memproses gambar: ' + error.message);
            }
        }
        
        // Fungsi untuk memproses pesan chatbot
        async function processChatMessage(message) {
            try {
                // Cek apakah pesan mengandung perhitungan sederhana
                if (/^hitung\s+[\d\.\+\-\*\/\(\)\s]+$/i.test(message)) {
                    // Pesan mengandung operasi matematika sederhana
                    const expression = message.replace(/^hitung\s+/i, '').replace(/\./g, '');
                    try {
                        const result = math.evaluate(expression);
                        const formattedResult = new Intl.NumberFormat('id-ID').format(result).replace(/,/g, '.');
                        
                        hideChatLoading();
                        addMessageToChat('bot', `Hasil perhitungan: ${formattedResult}`);
                        return;
                    } catch (calcError) {
                        console.error('Error in calculation:', calcError);
                    }
                }
                
                // Cek apakah pesan meminta perhitungan perolehan
                const perolehanRegex = /hitung\s+perolehan(?:\s+dengan)?(?:\s+SS\s+awal\s+([0-9\.]+))?(?:\s+before\s+spend\s+([0-9\.]+))?(?:\s+after\s+spend\s+([0-9\.]+))?(?:\s+SS\s+akhir\s+([0-9\.]+))?(?:\s+perolehan\s+sebelumnya\s+([0-9\.]+))?/i;
                const perolehanMatch = message.match(perolehanRegex);
                
                if (perolehanMatch) {
                    // Bersihkan dari titik
                    const ssAwal = perolehanMatch[1] ? parseIDNumber(perolehanMatch[1]) : parseIDNumber(document.getElementById('ssAwal').value);
                    const beforeSpend = perolehanMatch[2] ? parseIDNumber(perolehanMatch[2]) : parseIDNumber(document.getElementById('beforeSpend').value);
                    const afterSpend = perolehanMatch[3] ? parseIDNumber(perolehanMatch[3]) : parseIDNumber(document.getElementById('afterSpend').value);
                    const ssAkhir = perolehanMatch[4] ? parseIDNumber(perolehanMatch[4]) : parseIDNumber(document.getElementById('ssAkhir').value);
                    const perolehanSebelumnya = perolehanMatch[5] ? parseIDNumber(perolehanMatch[5]) : parseIDNumber(document.getElementById('perolehanSebelumnya').value);
                    
                    if (ssAwal && beforeSpend && afterSpend && ssAkhir) {
                        const result = chatCalculate(ssAwal, beforeSpend, afterSpend, ssAkhir, perolehanSebelumnya);
                        
                        const response = `
                            <strong>Hasil Perhitungan Perolehan:</strong><br>
                            SS Awal: ${new Intl.NumberFormat('id-ID').format(ssAwal).replace(/,/g, '.')}<br>
                            Before Spend: ${new Intl.NumberFormat('id-ID').format(beforeSpend).replace(/,/g, '.')}<br>
                            After Spend: ${new Intl.NumberFormat('id-ID').format(afterSpend).replace(/,/g, '.')}<br>
                            SS Akhir: ${new Intl.NumberFormat('id-ID').format(ssAkhir).replace(/,/g, '.')}<br>
                            Perolehan Sebelumnya: ${new Intl.NumberFormat('id-ID').format(perolehanSebelumnya).replace(/,/g, '.')}<br><br>
                            <strong>Total Spend:</strong> ${new Intl.NumberFormat('id-ID').format(result.totalSpend).replace(/,/g, '.')}<br>
                            <strong>Perolehan:</strong> ${new Intl.NumberFormat('id-ID').format(result.perolehan).replace(/,/g, '.')}<br>
                            <strong>Total Perolehan:</strong> ${new Intl.NumberFormat('id-ID').format(result.totalPerolehan).replace(/,/g, '.')}
                        `;
                        
                        hideChatLoading();
                        addMessageToChat('bot', response);
                        return;
                    }
                }
                
                // Jika bukan perhitungan, gunakan Gemini API untuk respons
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            role: 'user',
                            parts: [
                                {
                                    text: `Kamu adalah asisten pintar untuk aplikasi Kalkulator Perolehan. Berikan jawaban yang bermanfaat, sopan, dan tidak terlalu panjang. Kamu bisa melakukan perhitungan matematika sederhana dan membantu pengguna. Jika ditanya tentang cara menghitung perolehan, jelaskan bahwa rumusnya adalah (SS Akhir - SS Awal) + (Before Spend - After Spend) untuk mendapatkan perolehan, dan Total Perolehan adalah Perolehan + Perolehan Sebelumnya.

                                    Jika diminta menghitung dan formatnya tidak benar, berikan instruksi cara menggunakannya. Untuk membantu berpikir, kamu juga bisa menggunakan perhitungan matematis.

                                    Ini adalah pesan dari pengguna: ${message}`
                                }
                            ]
                        }]
                    })
                });
                
                const data = await response.json();
                
                let botResponse = 'Maaf, saya tidak dapat memproses permintaan Anda saat ini.';
                if (data.candidates && data.candidates.length > 0 && 
                    data.candidates[0].content && data.candidates[0].content.parts) {
                    botResponse = data.candidates[0].content.parts[0].text;
                }
                
                hideChatLoading();
                addMessageToChat('bot', botResponse);
                
            } catch (error) {
                console.error('Error processing chat message:', error);
                hideChatLoading();
                addMessageToChat('bot', 'Maaf, terjadi kesalahan: ' + error.message);
            }
        }

        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).textContent;
            const textArea = document.createElement('textarea');
            // Text dengan format titik pemisah ribuan
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            // Tampilkan notifikasi yang lebih elegan
            const element = document.getElementById(elementId);
            const originalText = element.textContent;
            element.textContent = 'â Disalin!';
            element.classList.add('text-green-600');
            
            setTimeout(() => {
                element.textContent = originalText;
                element.classList.remove('text-green-600');
            }, 1000);
        }

        // Inisialisasi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = [
                document.getElementById('ssAwal'),
                document.getElementById('beforeSpend'),
                document.getElementById('afterSpend'),
                document.getElementById('ssAkhir'),
                document.getElementById('perolehanSebelumnya')
            ];
            
            inputs.forEach(input => formatNumberInput(input));
            
            // Muat data dari localStorage saat halaman dimuat
            loadFromLocalStorage();
            
            // Event listener untuk tombol calculate
            document.getElementById('calculateBtn').addEventListener('click', calculate);
            
            // Event listener untuk tombol reset
            document.getElementById('resetBtn').addEventListener('click', function() {
                if (confirm('Apakah Anda yakin ingin menghapus semua data?')) {
                    localStorage.removeItem('kalkulatorPerolehanData');
                    inputs.forEach(input => input.value = '');
                    document.getElementById('totalSpend').textContent = '0';
                    document.getElementById('perolehan').textContent = '0';
                    document.getElementById('totalPerolehan').textContent = '0';
                    showToast('Data berhasil direset');
                }
            });
            
            // Event listener untuk tombol simpan ke riwayat
            document.getElementById('saveHistoryBtn').addEventListener('click', saveToHistory);
            
            // Event listener untuk tombol riwayat (buka modal)
            document.getElementById('historyBtn').addEventListener('click', function() {
                document.getElementById('historyModal').classList.remove('hidden');
                renderHistoryList();
            });
            
            // Event listener untuk tombol tutup modal riwayat
            document.getElementById('closeHistoryBtn').addEventListener('click', function() {
                document.getElementById('historyModal').classList.add('hidden');
            });
            
            // Event listener untuk tombol hapus semua riwayat
            document.getElementById('clearHistoryBtn').addEventListener('click', function() {
                if (confirm('Apakah Anda yakin ingin menghapus semua riwayat?')) {
                    calculationHistory = [];
                    localStorage.setItem('kalkulatorPerolehanHistory', JSON.stringify(calculationHistory));
                    renderHistoryList();
                    showToast('Semua riwayat berhasil dihapus');
                }
            });
            
            // Event listener untuk tombol ekspor riwayat
            document.getElementById('exportHistoryBtn').addEventListener('click', exportHistory);
            
            // Event listener untuk tombol scan (buka modal)
            document.getElementById('scanBtn').addEventListener('click', function() {
                document.getElementById('scanModal').classList.remove('hidden');
                document.getElementById('imagePreviewContainer').classList.add('hidden');
                document.getElementById('cropContainer').classList.add('hidden');
                document.getElementById('scanResults').classList.add('hidden');
                document.getElementById('scanLoading').classList.add('hidden');
                document.getElementById('applyResultBtn').classList.add('hidden');
                document.getElementById('processImageBtn').disabled = true;
                document.getElementById('processImageBtn').classList.add('opacity-50');
                document.getElementById('imageUpload').value = '';
            });
            
            // Event listener untuk tombol tutup modal scan
            document.getElementById('closeScanBtn').addEventListener('click', function() {
                document.getElementById('scanModal').classList.add('hidden');
                
                // Hancurkan instance cropper jika ada
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            });
            
            // Event listener untuk unggah gambar
            document.getElementById('imageUpload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    
                    // Tampilkan preview gambar
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('imagePreview').src = event.target.result;
                        document.getElementById('imagePreviewContainer').classList.remove('hidden');
                        document.getElementById('cropContainer').classList.add('hidden');
                    }
                    reader.readAsDataURL(file);
                    
                    // Aktifkan tombol proses
                    document.getElementById('processImageBtn').disabled = false;
                    document.getElementById('processImageBtn').classList.remove('opacity-50');
                    
                    // Sembunyikan hasil sebelumnya
                    document.getElementById('scanResults').classList.add('hidden');
                    document.getElementById('applyResultBtn').classList.add('hidden');
                }
            });
            
            // Event listener untuk tombol proses gambar
            document.getElementById('processImageBtn').addEventListener('click', async function() {
                let imageFile;
                const imagePreview = document.getElementById('imagePreview');
                
                if (document.getElementById('imageUpload').files[0]) {
                    // Jika ada file yang diupload
                    imageFile = document.getElementById('imageUpload').files[0];
                } else if (imagePreview.src) {
                    // Jika ada gambar dari paste atau crop
                    imageFile = dataURLtoBlob(imagePreview.src);
                }
                
                if (imageFile) {
                    await extractTextFromImage(imageFile);
                }
            });
            
            // Event listener untuk tombol terapkan hasil OCR
            document.getElementById('applyResultBtn').addEventListener('click', function() {
                if (extractedValue) {
                    const targetField = document.getElementById('targetField').value;
                    document.getElementById(targetField).value = extractedValue;
                    document.getElementById('scanModal').classList.add('hidden');
                    showToast('Nilai berhasil diterapkan ke ' + document.getElementById('targetField').options[document.getElementById('targetField').selectedIndex].text);
                    
                    // Hancurkan instance cropper jika ada
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                    
                    // Simpan input ke localStorage
                    saveInputToLocalStorage();
                }
            });
            
            // Event listener untuk paste area
            const pasteArea = document.getElementById('pasteArea');
            pasteArea.addEventListener('click', function() {
                document.getElementById('pasteBtnImage').click();
            });
            
            // Event listener untuk tombol paste
            document.getElementById('pasteBtnImage').addEventListener('click', function() {
                navigator.clipboard.read().then(items => {
                    for (let item of items) {
                        if (item.types.includes('image/png') || item.types.includes('image/jpeg')) {
                            item.getType('image/png').then(blob => {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    document.getElementById('imagePreview').src = e.target.result;
                                    document.getElementById('imagePreviewContainer').classList.remove('hidden');
                                    document.getElementById('cropContainer').classList.add('hidden');
                                    
                                    // Aktifkan tombol proses
                                    document.getElementById('processImageBtn').disabled = false;
                                    document.getElementById('processImageBtn').classList.remove('opacity-50');
                                    
                                    // Sembunyikan hasil sebelumnya
                                    document.getElementById('scanResults').classList.add('hidden');
                                    document.getElementById('applyResultBtn').classList.add('hidden');
                                };
                                reader.readAsDataURL(blob);
                            });
                            break;
                        }
                    }
                }).catch(err => {
                    console.error('Error reading clipboard:', err);
                    alert('Tidak dapat mengakses clipboard. Pastikan Anda mengizinkan akses clipboard.');
                });
            });
            
            // Event listener untuk tombol crop
            document.getElementById('cropImageBtn').addEventListener('click', setupCropper);
            
            // Event listener untuk tombol terapkan crop
            document.getElementById('applyCropBtn').addEventListener('click', applyCrop);
            
            // Event listener untuk tombol batal crop
            document.getElementById('cancelCropBtn').addEventListener('click', cancelCrop);
            
            // Event listener untuk paste gambar
            document.addEventListener('paste', function(event) {
                // Check which modal is open
                if (!document.getElementById('scanModal').classList.contains('hidden')) {
                    handlePastedImage(event);
                } else if (!document.getElementById('chatOcrModal').classList.contains('hidden')) {
                    handleChatPastedImage(event);
                }
            });
            
            // Tutup modal jika klik di luar
            window.addEventListener('click', function(event) {
                const historyModal = document.getElementById('historyModal');
                const scanModal = document.getElementById('scanModal');
                const chatOcrModal = document.getElementById('chatOcrModal');
                
                if (event.target === historyModal) {
                    historyModal.classList.add('hidden');
                }
                
                if (event.target === scanModal) {
                    scanModal.classList.add('hidden');
                    
                    // Hancurkan instance cropper jika ada
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                }
                
                if (event.target === chatOcrModal) {
                    chatOcrModal.classList.add('hidden');
                    
                    // Hancurkan instance cropper jika ada
                    if (chatCropper) {
                        chatCropper.destroy();
                        chatCropper = null;
                    }
                }
            });
            
            // Support tombol Enter untuk menghitung
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    // Check if we're in the chat input
                    if (document.activeElement === document.getElementById('chat-input')) {
                        sendChatMessage();
                    } else {
                        calculate();
                    }
                }
            });
            
            // Chat related event listeners
            document.getElementById('send-btn').addEventListener('click', sendChatMessage);
            
            // Clear chat history
            document.getElementById('clearChatBtn').addEventListener('click', function() {
                if (confirm('Apakah Anda yakin ingin menghapus semua riwayat chat?')) {
                    chatHistory = [];
                    localStorage.setItem('kalkulatorPerolehanChat', JSON.stringify(chatHistory));
                    
                    // Clear chat display
                    const chatContainer = document.getElementById('chat-container');
                    chatContainer.innerHTML = '';
                    
                    // Add welcome message
                    addMessageToChat('bot', `Halo! Saya adalah AI Assistant Anda untuk membantu perhitungan dan menjawab pertanyaan. Anda dapat:
                    <ul class="list-disc ml-5 mt-2">
                        <li>Melakukan perhitungan matematika (contoh: "hitung 2500 * 3 + 450")</li>
                        <li>Meminta saya menghitung perolehan (contoh: "hitung perolehan dengan SS awal 4000, before spend 5000, after spend 3000, SS akhir 5000")</li>
                        <li>Mengirim gambar untuk OCR (klik ikon kamera di bawah)</li>
                        <li>Atau bertanya tentang apa saja!</li>
                    </ul>`);
                    
                    showToast('Riwayat chat berhasil dihapus');
                }
            });
            
            // Chat image button
            document.getElementById('chatImageBtn').addEventListener('click', function() {
                document.getElementById('chatOcrModal').classList.remove('hidden');
                document.getElementById('chatImagePreviewContainer').classList.add('hidden');
                document.getElementById('chatCropContainer').classList.add('hidden');
                document.getElementById('sendChatImageBtn').disabled = true;
                document.getElementById('sendChatImageBtn').classList.add('opacity-50');
                document.getElementById('chat-image-upload').value = '';
                document.getElementById('chat-image-instruction').value = '';
            });
            
            // Chat close OCR modal
            document.getElementById('closeChatOcrBtn').addEventListener('click', function() {
                document.getElementById('chatOcrModal').classList.add('hidden');
                
                // Hancurkan instance cropper jika ada
                if (chatCropper) {
                    chatCropper.destroy();
                    chatCropper = null;
                }
            });
            
            // Chat image upload
            document.getElementById('chatImageUpload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    
                    // Tampilkan preview gambar
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('chatImagePreview').src = event.target.result;
                        document.getElementById('chatImagePreviewContainer').classList.remove('hidden');
                        document.getElementById('chatCropContainer').classList.add('hidden');
                    }
                    reader.readAsDataURL(file);
                    
                    // Aktifkan tombol kirim
                    document.getElementById('sendChatImageBtn').disabled = false;
                    document.getElementById('sendChatImageBtn').classList.remove('opacity-50');
                }
            });
            
            // Chat paste area
            const chatPasteArea = document.getElementById('chatPasteArea');
            chatPasteArea.addEventListener('click', function() {
                document.getElementById('chatPasteBtnImage').click();
            });
            
            // Chat paste button
            document.getElementById('chatPasteBtnImage').addEventListener('click', function() {
                navigator.clipboard.read().then(items => {
                    for (let item of items) {
                        if (item.types.includes('image/png') || item.types.includes('image/jpeg')) {
                            item.getType('image/png').then(blob => {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    document.getElementById('chatImagePreview').src = e.target.result;
                                    document.getElementById('chatImagePreviewContainer').classList.remove('hidden');
                                    document.getElementById('chatCropContainer').classList.add('hidden');
                                    
                                    // Aktifkan tombol kirim
                                    document.getElementById('sendChatImageBtn').disabled = false;
                                    document.getElementById('sendChatImageBtn').classList.remove('opacity-50');
                                };
                                reader.readAsDataURL(blob);
                            });
                            break;
                        }
                    }
                }).catch(err => {
                    console.error('Error reading clipboard:', err);
                    alert('Tidak dapat mengakses clipboard. Pastikan Anda mengizinkan akses clipboard.');
                });
            });
            
            // Chat crop button
            document.getElementById('chatCropImageBtn').addEventListener('click', setupChatCropper);
            
            // Chat apply crop button
            document.getElementById('chatApplyCropBtn').addEventListener('click', applyChatCrop);
            
            // Chat cancel crop button
            document.getElementById('chatCancelCropBtn').addEventListener('click', cancelChatCrop);
            
            // Send chat image button
            document.getElementById('sendChatImageBtn').addEventListener('click', sendChatImage);
            
            // Quick prompts
            document.querySelectorAll('.quick-prompt').forEach(button => {
                button.addEventListener('click', function() {
                    const promptText = this.textContent;
                    document.getElementById('chat-input').value = promptText;
                    sendChatMessage();
                });
            });
        });
    </script>
</body>
</html>
