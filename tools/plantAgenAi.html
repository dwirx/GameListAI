<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plant Agent AI - Perencana Usaha Professional</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
            secondary: '#facc15',
            accent: '#10b981',
            dark: '#1e293b',
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    .thinking-animation {
      background: linear-gradient(90deg, #f0f9ff 25%, #dbeafe 50%, #f0f9ff 75%);
      background-size: 200% 100%;
      animation: thinking-bg 2s infinite;
    }
    
    @keyframes thinking-bg {
      0% { background-position: 0% 0; }
      100% { background-position: -200% 0; }
    }
    
    .checklist-item:hover {
      background-color: rgba(37, 99, 235, 0.05);
    }
    
    .task-completed {
      text-decoration: line-through;
      opacity: 0.7;
    }
    
    .progress-bar-fill {
      transition: width 0.5s ease-in-out;
    }
    
    .history-item {
      transition: all 0.3s ease;
    }
    
    .history-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .expanded-analysis {
      max-height: 1000px;
      transition: max-height 0.5s ease-in-out;
    }
    
    .collapsed-analysis {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease-in-out;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background: #1e293b;
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 50;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    @media (max-width: 640px) {
      .mobile-overflow-x-scroll {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }
    
    /* Print styles */
    @media print {
      body {
        background: white !important;
      }
      
      .no-print {
        display: none !important;
      }
      
      .print-container {
        display: block !important;
        width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        border: none !important;
        box-shadow: none !important;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-green-50 min-h-screen py-8 px-4 font-sans">
  <div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg ring-1 ring-gray-200 mb-6">
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6">
        <div>
          <h1 class="text-3xl sm:text-4xl font-extrabold bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent">Plant Agent AI</h1>
          <p class="text-gray-600 text-base sm:text-lg mt-1">Mitra cerdas untuk perencanaan dan pengembangan bisnis Anda</p>
        </div>
        <div class="bg-blue-50 p-2 rounded-lg mt-4 sm:mt-0">
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-primary">
            <i class="fas fa-robot mr-2"></i> Pro Business Planner
          </span>
        </div>
      </div>
      
      <div class="space-y-6">
        <div>
          <label for="idea" class="block text-gray-700 font-semibold mb-2 text-lg">
            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Ide Usaha Anda:
          </label>
          <textarea 
            id="idea" 
            rows="4" 
            class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300 text-gray-700"
            placeholder="Contoh: Jualan baju distro dengan modal 3 juta, target pasar anak muda, lokasi di kota kecil..."
          ></textarea>
        </div>
        
        <div class="flex flex-wrap gap-4">
          <button 
            id="generateBtn"
            onclick="generatePlan()" 
            class="bg-primary hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-xl transition duration-200 flex items-center shadow-md hover:shadow-lg">
            <i class="fas fa-wand-magic-sparkles mr-2"></i> Buat Rencana
          </button>
          
          <button 
            id="clearBtn"
            onclick="clearAll()" 
            class="bg-white hover:bg-gray-100 text-gray-700 font-semibold py-3 px-6 rounded-xl transition duration-200 border border-gray-300 hover:border-gray-400">
            <i class="fas fa-eraser mr-2"></i> Reset
          </button>
          
          <button 
            id="historyBtn"
            onclick="toggleHistoryPanel()" 
            class="bg-blue-50 hover:bg-blue-100 text-primary font-semibold py-3 px-6 rounded-xl transition duration-200 border border-blue-200">
            <i class="fas fa-history mr-2"></i> Riwayat
          </button>
        </div>
      </div>
    </div>
    
    <!-- History Panel (Hidden by default) -->
    <div id="historyPanel" class="hidden bg-white p-6 rounded-2xl shadow-lg mb-6 overflow-hidden">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-800">Riwayat Rencana Bisnis</h3>
        <button onclick="toggleHistoryPanel()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
      
      <div id="historyList" class="space-y-3 max-h-96 overflow-y-auto mb-4">
        <!-- History items will be populated here -->
        <p id="noHistoryMessage" class="text-gray-500 text-center py-8">Belum ada riwayat rencana bisnis tersimpan</p>
      </div>
      
      <div class="flex justify-end border-t pt-4">
        <button onclick="clearAllHistory()" class="text-red-500 hover:text-red-700 font-medium text-sm flex items-center">
          <i class="fas fa-trash mr-2"></i> Hapus Semua Riwayat
        </button>
      </div>
    </div>
    
    <!-- Loading State -->
    <div id="thinkingProcess" class="hidden bg-white p-6 rounded-2xl shadow-md mb-6">
      <div class="flex items-center mb-4">
        <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center mr-3">
          <i class="fas fa-brain text-primary"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-800">Proses Pemikiran AI</h3>
      </div>
      
      <div id="thinkingSteps" class="space-y-3 max-h-96 overflow-y-auto">
        <!-- Thinking steps will be added here -->
      </div>
    </div>
    
    <!-- Loading indicator -->
    <div id="loading" class="hidden bg-white p-8 rounded-2xl shadow-md mb-6">
      <div class="flex flex-col items-center justify-center">
        <div class="thinking-animation h-12 w-12 rounded-full mb-4 flex items-center justify-center">
          <i class="fas fa-cogs text-primary text-2xl animate-pulse-slow"></i>
        </div>
        <p class="text-lg font-medium text-primary mb-2">Sedang menyusun rencana usaha...</p>
        <p class="text-gray-500 text-center max-w-md">Plant Agent AI sedang menganalisis ide Anda dan menyusun strategi bisnis yang optimal</p>
        
        <div class="w-full max-w-md mt-6 bg-gray-200 rounded-full h-2.5">
          <div id="loadingBar" class="bg-primary h-2.5 rounded-full progress-bar-fill" style="width: 10%"></div>
        </div>
      </div>
    </div>
    
    <!-- Results Section -->
    <div id="outputSection" class="hidden space-y-6">
      <!-- Business Plan -->
      <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg print-container">
        <div class="flex items-center mb-6">
          <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
            <i class="fas fa-file-invoice text-primary"></i>
          </div>
          <h2 class="text-2xl font-bold text-gray-800">Rencana Bisnis</h2>
        </div>
        
        <div id="output" class="prose max-w-none text-gray-700 whitespace-pre-wrap bg-gray-50 p-4 sm:p-6 rounded-xl border border-gray-200"></div>
        
        <div class="mt-6 flex justify-end gap-3 no-print">
          <button onclick="requestDeepAnalysis()" class="inline-flex items-center bg-blue-50 hover:bg-blue-100 text-primary px-4 py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-search-plus mr-2"></i> Analisis Mendalam
          </button>
          <button onclick="copyToClipboard()" class="inline-flex items-center text-gray-600 hover:text-primary text-sm font-medium">
            <i class="far fa-copy mr-2"></i> Salin Teks
          </button>
        </div>
      </div>
      
      <!-- Tabs for different sections -->
      <div class="bg-white rounded-2xl shadow-lg overflow-hidden no-print">
        <div class="border-b border-gray-200 mobile-overflow-x-scroll">
          <nav class="flex -mb-px">
            <button
              onclick="switchTab('checklist')"
              id="checklistTab"
              class="tab-active py-4 px-6 font-medium text-sm border-b-2 border-primary text-primary focus:outline-none">
              <i class="fas fa-tasks mr-2"></i> Checklist Tugas
            </button>
            <button
              onclick="switchTab('financial')"
              id="financialTab"
              class="py-4 px-6 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none">
              <i class="fas fa-chart-pie mr-2"></i> Proyeksi Keuangan
            </button>
            <button
              onclick="switchTab('analysis')"
              id="analysisTab"
              class="py-4 px-6 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none">
              <i class="fas fa-chart-line mr-2"></i> Analisis Mendalam
            </button>
            <button
              onclick="switchTab('solution')"
              id="solutionTab" 
              class="py-4 px-6 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none">
              <i class="fas fa-lightbulb mr-2"></i> Solusi & Tindakan
            </button>
          </nav>
        </div>
        
        <!-- Checklist Content -->
        <div id="checklistContent" class="p-6">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
            <div class="flex items-center">
              <h3 class="text-xl font-semibold text-gray-800">Checklist Implementasi</h3>
              <span id="taskCompletion" class="ml-3 text-sm font-medium text-gray-500">0/0 selesai</span>
            </div>
            <div class="flex gap-2">
              <button id="analyzeTasksBtn" onclick="analyzeCheckedTasks()" class="text-sm bg-blue-50 hover:bg-blue-100 text-primary px-3 py-1.5 rounded-lg">
                <i class="fas fa-brain mr-1"></i> Analisis Tugas Terpilih
              </button>
              <button onclick="toggleAllTasks()" class="text-sm text-primary hover:text-blue-700">
                <i class="fas fa-check-double mr-1"></i> Toggle Semua
              </button>
            </div>
          </div>
          
          <div class="w-full bg-gray-200 rounded-full h-2 mb-6">
            <div id="progressBar" class="bg-accent h-2 rounded-full" style="width: 0%"></div>
          </div>
          
          <div class="space-y-1">
            <div class="flex justify-between text-sm font-medium text-gray-500 mb-2">
              <span>Tugas</span>
              <span>Status</span>
            </div>
            <ul id="taskList" class="space-y-2 max-h-96 overflow-y-auto"></ul>
          </div>
          
          <!-- Task Analysis Result (Hidden by default) -->
          <div id="taskAnalysisResult" class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100 hidden">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold text-primary">Analisis Tugas Terpilih</h4>
              <button onclick="document.getElementById('taskAnalysisResult').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div id="taskAnalysisContent" class="text-gray-700 text-sm"></div>
          </div>
        </div>
        
        <!-- Financial Content -->
        <div id="financialContent" class="p-6 hidden">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">Proyeksi Keuangan</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
              <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
                <h4 class="font-medium text-gray-700">Proyeksi Pendapatan & Pengeluaran</h4>
              </div>
              <div class="p-4 h-64">
                <canvas id="revenueChart"></canvas>
              </div>
            </div>
            
            <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
              <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
                <h4 class="font-medium text-gray-700">Analisis Break Even Point</h4>
              </div>
              <div class="p-4 h-64">
                <canvas id="bepChart"></canvas>
              </div>
            </div>
          </div>
          
          <div class="mt-6">
            <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
              <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
                <h4 class="font-medium text-gray-700">Rincian Keuangan</h4>
              </div>
              <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div class="bg-blue-50 p-4 rounded-lg">
                    <h5 class="text-xs font-medium text-gray-500 mb-1">MODAL AWAL</h5>
                    <p id="initialCapital" class="text-2xl font-bold text-primary">Rp 0</p>
                  </div>
                  
                  <div class="bg-yellow-50 p-4 rounded-lg">
                    <h5 class="text-xs font-medium text-gray-500 mb-1">BIAYA OPERASIONAL BULANAN</h5>
                    <p id="monthlyExpense" class="text-2xl font-bold text-yellow-600">Rp 0</p>
                  </div>
                  
                  <div class="bg-green-50 p-4 rounded-lg">
                    <h5 class="text-xs font-medium text-gray-500 mb-1">PROYEKSI PENDAPATAN BULANAN</h5>
                    <p id="monthlyRevenue" class="text-2xl font-bold text-green-600">Rp 0</p>
                  </div>
                </div>
                
                <div class="mt-4">
                  <div class="bg-indigo-50 p-4 rounded-lg">
                    <h5 class="font-medium text-indigo-700 mb-2">Proyeksi BEP (Break Even Point)</h5>
                    <div class="flex flex-col sm:flex-row gap-4">
                      <div class="flex-1">
                        <p class="text-sm text-gray-600 mb-1">Waktu untuk BEP:</p>
                        <p id="bepTime" class="text-lg font-semibold text-indigo-800">-</p>
                      </div>
                      <div class="flex-1">
                        <p class="text-sm text-gray-600 mb-1">Nominal untuk BEP:</p>
                        <p id="bepAmount" class="text-lg font-semibold text-indigo-800">-</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div id="financialDetails" class="mt-4 bg-gray-50 p-4 rounded-lg text-gray-700 text-sm"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Analysis Content -->
        <div id="analysisContent" class="p-6 hidden">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">Analisis Mendalam</h3>
          <div class="space-y-4">
            <div id="swotAnalysis" class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="font-semibold text-primary mb-2">Kekuatan</h4>
                <ul id="strengthsList" class="list-disc pl-5 text-gray-700"></ul>
              </div>
              <div class="bg-red-50 p-4 rounded-lg">
                <h4 class="font-semibold text-red-600 mb-2">Kelemahan</h4>
                <ul id="weaknessesList" class="list-disc pl-5 text-gray-700"></ul>
              </div>
              <div class="bg-green-50 p-4 rounded-lg">
                <h4 class="font-semibold text-green-600 mb-2">Peluang</h4>
                <ul id="opportunitiesList" class="list-disc pl-5 text-gray-700"></ul>
              </div>
              <div class="bg-yellow-50 p-4 rounded-lg">
                <h4 class="font-semibold text-yellow-600 mb-2">Ancaman</h4>
                <ul id="threatsList" class="list-disc pl-5 text-gray-700"></ul>
              </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="flex justify-between items-center cursor-pointer" onclick="toggleSection('financialAnalysisSection')">
                <h4 class="font-semibold text-gray-700">Analisis Keuangan</h4>
                <i id="financialAnalysisIcon" class="fas fa-chevron-down text-gray-400"></i>
              </div>
              <div id="financialAnalysisSection" class="text-gray-700 mt-2 expanded-analysis"></div>
            </div>
            
            <div class="bg-purple-50 p-4 rounded-lg">
              <div class="flex justify-between items-center cursor-pointer" onclick="toggleSection('marketAnalysisSection')">
                <h4 class="font-semibold text-purple-700">Analisis Pasar</h4>
                <i id="marketAnalysisIcon" class="fas fa-chevron-down text-gray-400"></i>
              </div>
              <div id="marketAnalysisSection" class="text-gray-700 mt-2 expanded-analysis"></div>
            </div>
            
            <div class="bg-indigo-50 p-4 rounded-lg">
              <div class="flex justify-between items-center cursor-pointer" onclick="toggleSection('competitorAnalysisSection')">
                <h4 class="font-semibold text-indigo-700">Analisis Kompetitor</h4>
                <i id="competitorAnalysisIcon" class="fas fa-chevron-down text-gray-400"></i>
              </div>
              <div id="competitorAnalysisSection" class="text-gray-700 mt-2 expanded-analysis"></div>
            </div>
          </div>
        </div>
        
        <!-- Solution Content -->
        <div id="solutionContent" class="p-6 hidden">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">Solusi & Tindakan Lanjutan</h3>
          
          <div class="space-y-4">
            <div class="bg-blue-50 p-4 rounded-lg">
              <h4 class="font-semibold text-primary mb-2">Langkah Awal (1-3 bulan)</h4>
              <ul id="shortTermList" class="list-disc pl-5 text-gray-700"></ul>
            </div>
            
            <div class="bg-indigo-50 p-4 rounded-lg">
              <h4 class="font-semibold text-indigo-600 mb-2">Pertumbuhan (3-12 bulan)</h4>
              <ul id="midTermList" class="list-disc pl-5 text-gray-700"></ul>
            </div>
            
            <div class="bg-purple-50 p-4 rounded-lg">
              <h4 class="font-semibold text-purple-600 mb-2">Ekspansi (1-3 tahun)</h4>
              <ul id="longTermList" class="list-disc pl-5 text-gray-700"></ul>
            </div>
            
            <div class="bg-green-50 p-4 rounded-lg">
              <div class="flex justify-between items-center cursor-pointer" onclick="toggleSection('challengesSection')">
                <h4 class="font-semibold text-green-600">Tantangan & Solusi</h4>
                <i id="challengesSectionIcon" class="fas fa-chevron-down text-gray-400"></i>
              </div>
              <div id="challengesSection" class="text-gray-700 mt-2 expanded-analysis"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="flex flex-wrap gap-4 justify-center sm:justify-start no-print">
        <button onclick="saveToLocal()" class="inline-flex items-center bg-accent hover:bg-green-700 text-white py-2.5 px-5 rounded-xl shadow-md transition duration-200">
          <i class="fas fa-save mr-2"></i> Simpan Rencana
        </button>
        <button onclick="printReport()" class="inline-flex items-center bg-gray-800 hover:bg-black text-white py-2.5 px-5 rounded-xl shadow-md transition duration-200">
          <i class="fas fa-print mr-2"></i> Cetak
        </button>
        <button onclick="downloadPDF()" class="inline-flex items-center bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 px-5 rounded-xl shadow-md transition duration-200">
          <i class="fas fa-file-pdf mr-2"></i> Ekspor PDF
        </button>
        <button onclick="shareResults()" class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-5 rounded-xl shadow-md transition duration-200">
          <i class="fas fa-share-alt mr-2"></i> Bagikan
        </button>
      </div>
    </div>
    
    <!-- Toast notifications -->
    <div id="toast" class="toast">
      <div class="flex items-center">
        <i id="toastIcon" class="mr-2"></i>
        <span id="toastMessage"></span>
      </div>
    </div>
    
    <!-- Footer -->
    <footer class="mt-12 text-center text-gray-500 text-sm no-print">
      <p>Plant Agent AI &copy; 2025 - Asisten Perencanaan Bisnis Cerdas</p>
    </footer>
  </div>
  
  <script>
    let latestPlan = '';
    let allTasks = [];
    let taskCompleted = 0;
    let analysisData = {};
    let financialData = {
      initialCapital: 0,
      monthlyExpense: 0,
      monthlyRevenue: 0,
      bepMonths: 0,
      bepAmount: 0,
      projections: []
    };
    let thinkingStep = 0;
    let revenueChart = null;
    let bepChart = null;
    let savedPlans = [];
    
    const thinkingSteps = [
      "Menganalisis ide usaha...",
      "Menilai kelayakan pasar...",
      "Menghitung estimasi modal dan biaya...",
      "Mengidentifikasi target konsumen...",
      "Menyusun strategi marketing...",
      "Menganalisis kompetitor...",
      "Membuat proyeksi keuangan...",
      "Merancang jadwal implementasi...",
      "Mengidentifikasi risiko dan mitigasi...",
      "Finalisasi rencana bisnis..."
    ];
    
    // Initialize tab functionality
    function switchTab(tabName) {
      // Hide all content
      document.getElementById('checklistContent').classList.add('hidden');
      document.getElementById('financialContent').classList.add('hidden');
      document.getElementById('analysisContent').classList.add('hidden');
      document.getElementById('solutionContent').classList.add('hidden');
      
      // Remove active class from all tabs
      document.getElementById('checklistTab').classList.remove('tab-active', 'border-primary', 'text-primary');
      document.getElementById('financialTab').classList.remove('tab-active', 'border-primary', 'text-primary');
      document.getElementById('analysisTab').classList.remove('tab-active', 'border-primary', 'text-primary');
      document.getElementById('solutionTab').classList.remove('tab-active', 'border-primary', 'text-primary');
      
      document.getElementById('checklistTab').classList.add('border-transparent', 'text-gray-500');
      document.getElementById('financialTab').classList.add('border-transparent', 'text-gray-500');
      document.getElementById('analysisTab').classList.add('border-transparent', 'text-gray-500');
      document.getElementById('solutionTab').classList.add('border-transparent', 'text-gray-500');
      
      // Show selected content and activate tab
      document.getElementById(tabName + 'Content').classList.remove('hidden');
      document.getElementById(tabName + 'Tab').classList.add('tab-active', 'border-primary', 'text-primary');
      document.getElementById(tabName + 'Tab').classList.remove('border-transparent', 'text-gray-500');
      
      // Special logic for financial tab - initialize charts if needed
      if (tabName === 'financial' && financialData.projections.length > 0) {
        if (!revenueChart || !bepChart) {
          initializeFinancialCharts();
        }
      }
    }
    
    // Simulate AI thinking process
    function simulateThinking() {
      const thinkingProcess = document.getElementById('thinkingProcess');
      const thinkingStepsContainer = document.getElementById('thinkingSteps');
      const loadingBar = document.getElementById('loadingBar');
      
      thinkingProcess.classList.remove('hidden');
      thinkingStepsContainer.innerHTML = '';
      thinkingStep = 0;
      
      const interval = setInterval(() => {
        if (thinkingStep < thinkingSteps.length) {
          const step = document.createElement('div');
          step.className = 'flex items-start';
          step.innerHTML = `
            <div class="h-5 w-5 rounded-full bg-blue-100 flex items-center justify-center mr-3 mt-0.5">
              <i class="fas fa-check text-xs text-primary"></i>
            </div>
            <p class="text-gray-700">${thinkingSteps[thinkingStep]}</p>
          `;
          thinkingStepsContainer.appendChild(step);
          thinkingStep++;
          
          // Update progress bar
          const progress = (thinkingStep / thinkingSteps.length) * 100;
          loadingBar.style.width = `${progress}%`;
          
          // Auto-scroll to bottom
          thinkingStepsContainer.scrollTop = thinkingStepsContainer.scrollHeight;
        } else {
          clearInterval(interval);
        }
      }, 800);
      
      return interval;
    }
    
    async function generatePlan() {
      const idea = document.getElementById('idea').value.trim();
      if (!idea) {
        showToast('Tolong masukkan ide usaha terlebih dahulu.', 'fa-exclamation-circle', 'text-yellow-500');
        return;
      }
      
      // Reset and show loading states
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('outputSection').classList.add('hidden');
      document.getElementById('generateBtn').disabled = true;
      document.getElementById('generateBtn').classList.add('opacity-70');
      
      // Start thinking animation
      const thinkingInterval = simulateThinking();
      
      try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer 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'
          },
          body: JSON.stringify({
            model: 'meta-llama/llama-4-scout-17b-16e-instruct',
            messages: [
              { 
                role: 'system', 
                content: `Kamu adalah Plant Agent AI, perencana usaha cerdas. Buatkan analisis lengkap dengan format yang terstruktur untuk ide bisnis yang diajukan oleh pengguna. Berikan dalam format berikut:

                1. RINGKASAN EKSEKUTIF - Ringkasan singkat ide bisnis
                2. ANALISIS PASAR - Analisis target pasar, ukuran pasar, dan peluang
                3. RENCANA FINANSIAL - Perkiraan modal awal, biaya operasional, proyeksi pendapatan, dan BEP dengan angka yang realistis
                4. STRATEGI MARKETING - Cara memasarkan produk/jasa
                5. ROADMAP IMPLEMENTASI - Langkah-langkah konkret dengan timeline
                6. ANALISIS RISIKO - Risiko potensial dan strategi mitigasi
                7. SARAN PENGEMBANGAN - Rekomendasi untuk pengembangan jangka panjang
                
                PENTING: Berikan juga data SWOT (Strength, Weakness, Opportunity, Threat) yang jelas.
                Berikan daftar tugas (task list) yang terperinci yang perlu dilakukan.
                
                Berikan juga tiga kategori tindakan dengan rinci: Jangka Pendek (1-3 bulan), Jangka Menengah (3-12 bulan), dan Jangka Panjang (1-3 tahun).
                
                Di bagian Rencana Finansial, sertakan: 
                - Modal awal yang diperlukan dengan rincian
                - Biaya operasional bulanan 
                - Proyeksi pendapatan bulanan (minimal 12 bulan)
                - Analisis BEP (break even point) dalam bulan dan nominal uang`
              },
              { role: 'user', content: idea }
            ],
            temperature: 0.7,
            top_p: 1,
            max_completion_tokens: 2048,
            stream: false
          })
        });
        
        const data = await response.json();
        const reply = data.choices[0].message.content;
        latestPlan = reply;
        
        // Process AI response and update UI
        processPlanResponse(reply);
        
        // Hide loading, show results
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('outputSection').classList.remove('hidden');
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('generateBtn').classList.remove('opacity-70');
        clearInterval(thinkingInterval);
        
        // Show a success message
        showToast('Rencana bisnis berhasil dibuat!', 'fa-check-circle', 'text-green-500');
        
      } catch (error) {
        console.error('Error generating plan:', error);
        showToast('Terjadi kesalahan saat membuat rencana. Silakan coba lagi.', 'fa-exclamation-triangle', 'text-red-500');
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('generateBtn').classList.remove('opacity-70');
        clearInterval(thinkingInterval);
      }
    }
    
    function processPlanResponse(reply) {
      // Display full plan
      document.getElementById('output').innerHTML = formatTextWithSections(reply);
      
      // Extract and create tasks
      extractTasks(reply);
      
      // Extract and display SWOT and analysis
      extractAnalysis(reply);
      
      // Extract solution steps
      extractSolutions(reply);
      
      // Extract financial data
      extractFinancialData(reply);
      
      // Initialize financial charts if data available
      if (financialData.projections.length > 0) {
        initializeFinancialCharts();
      }
      
      // Switch to Checklist tab
      switchTab('checklist');
    }
    
    function formatTextWithSections(text) {
      // Format the text with better headings and styling
      return text
        .replace(/^(#+ .+)$/gm, '<h3 class="text-xl font-bold text-primary my-3">$1</h3>')
        .replace(/^([0-9]+\. .+)$/gm, '<h4 class="text-lg font-semibold text-gray-800 mt-4 mb-2">$1</h4>')
        .replace(/^(RINGKASAN EKSEKUTIF|ANALISIS PASAR|RENCANA FINANSIAL|STRATEGI MARKETING|ROADMAP IMPLEMENTASI|ANALISIS RISIKO|SARAN PENGEMBANGAN)(.*)$/gim, 
          '<h3 class="text-xl font-bold text-primary my-3">$1$2</h3>')
        .replace(/\n\n/g, '<br><br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>');
    }
    
    function extractTasks(text) {
      const taskList = document.getElementById('taskList');
      taskList.innerHTML = '';
      allTasks = [];
      
      // Look for bullet points, numbered items, or task-like sentences
      const taskRegex = /^[-*•]\s+(.+)$|^[0-9]+\.\s+(.+)$|^(Lakukan|Buat|Siapkan|Kembangkan|Teliti|Analisis|Implement|Jalankan|Susun|Rencanakan)(.+)$/gim;
      let match;
      
      const seenTasks = new Set();
      
      while ((match = taskRegex.exec(text)) !== null) {
        const taskText = match[1] || match[2] || (match[3] + match[4]);
        
        // Skip if task is too short or already seen
        if (taskText.length < 5 || seenTasks.has(taskText)) continue;
        seenTasks.add(taskText);
        
        // Skip if the task contains SWOT-related terms (to prevent duplication)
        if (/kekuatan|kelemahan|peluang|ancaman|strengths|weaknesses|opportunities|threats/i.test(taskText)) {
          continue;
        }
        
        const task = {
          text: taskText,
          completed: false,
          id: 'task-' + allTasks.length
        };
        
        allTasks.push(task);
        
        const li = document.createElement('li');
        li.className = 'checklist-item flex justify-between items-center p-3 rounded-lg border border-gray-200 hover:border-primary transition-all duration-200';
        li.id = task.id;
        li.innerHTML = `
          <label class="flex items-start flex-1 cursor-pointer">
            <input type="checkbox" onchange="updateTaskStatus(this, '${task.id}')" class="mr-3 mt-1 h-5 w-5 rounded border-gray-300 text-primary focus:ring-primary">
            <span class="text-gray-700">${taskText}</span>
          </label>
          <span class="text-xs font-medium px-2 py-1 rounded-full bg-yellow-100 text-yellow-800">Pending</span>
        `;
        
        taskList.appendChild(li);
      }
      
      // If few tasks were found, extract more tasks from imperative sentences
      if (allTasks.length < 5) {
        const imperative = /\n([A-Z][^\.!?]*\b(lakukan|buat|kembangkan|implementasikan|jalankan|mulai|teliti|analisis|susun|rencanakan|targetkan|pasarkan|promosikan|tentukan)[^\.!?]*\.)/gi;
        while ((match = imperative.exec(text)) !== null) {
          const taskText = match[1].trim();
          if (taskText.length > 10 && !seenTasks.has(taskText)) {
            seenTasks.add(taskText);
            const task = {
              text: taskText,
              completed: false,
              id: 'task-' + allTasks.length
            };
            
            allTasks.push(task);
            
            const li = document.createElement('li');
            li.className = 'checklist-item flex justify-between items-center p-3 rounded-lg border border-gray-200 hover:border-primary transition-all duration-200';
            li.id = task.id;
            li.innerHTML = `
              <label class="flex items-start flex-1 cursor-pointer">
                <input type="checkbox" onchange="updateTaskStatus(this, '${task.id}')" class="mr-3 mt-1 h-5 w-5 rounded border-gray-300 text-primary focus:ring-primary">
                <span class="text-gray-700">${taskText}</span>
              </label>
              <span class="text-xs font-medium px-2 py-1 rounded-full bg-yellow-100 text-yellow-800">Pending</span>
            `;
            
            taskList.appendChild(li);
          }
        }
      }
      
      updateTaskProgress();
    }
    
    function updateTaskStatus(checkbox, taskId) {
      const taskItem = document.getElementById(taskId);
      const statusBadge = taskItem.querySelector('span:last-child');
      const taskText = taskItem.querySelector('label span');
      
      const taskIndex = allTasks.findIndex(t => t.id === taskId);
      if (taskIndex !== -1) {
        allTasks[taskIndex].completed = checkbox.checked;
      }
      
      if (checkbox.checked) {
        statusBadge.className = 'text-xs font-medium px-2 py-1 rounded-full bg-green-100 text-green-800';
        statusBadge.textContent = 'Selesai';
        taskText.classList.add('task-completed');
      } else {
        statusBadge.className = 'text-xs font-medium px-2 py-1 rounded-full bg-yellow-100 text-yellow-800';
        statusBadge.textContent = 'Pending';
        taskText.classList.remove('task-completed');
      }
      
      updateTaskProgress();
    }
    
    function updateTaskProgress() {
      taskCompleted = allTasks.filter(t => t.completed).length;
      const totalTasks = allTasks.length;
      const progressBar = document.getElementById('progressBar');
      const taskCompletion = document.getElementById('taskCompletion');
      
      if (totalTasks > 0) {
        const progressPercent = (taskCompleted / totalTasks) * 100;
        progressBar.style.width = `${progressPercent}%`;
        taskCompletion.textContent = `${taskCompleted}/${totalTasks} selesai`;
        
        // Show analyze button only if there are checked tasks
        const analyzeTasksBtn = document.getElementById('analyzeTasksBtn');
        if (taskCompleted > 0) {
          analyzeTasksBtn.classList.remove('hidden');
        } else {
          analyzeTasksBtn.classList.add('hidden');
        }
      } else {
        progressBar.style.width = '0%';
        taskCompletion.textContent = '0/0 selesai';
      }
    }
    
    function toggleAllTasks() {
      const allChecked = allTasks.every(t => t.completed);
      allTasks.forEach(task => {
        const checkbox = document.querySelector(`#${task.id} input[type="checkbox"]`);
        checkbox.checked = !allChecked;
        updateTaskStatus(checkbox, task.id);
      });
    }
    
    function extractAnalysis(text) {
      // Extract SWOT
      const strengthsList = document.getElementById('strengthsList');
      const weaknessesList = document.getElementById('weaknessesList');
      const opportunitiesList = document.getElementById('opportunitiesList');
      const threatsList = document.getElementById('threatsList');
      const financialAnalysisSection = document.getElementById('financialAnalysisSection');
      const marketAnalysisSection = document.getElementById('marketAnalysisSection');
      const competitorAnalysisSection = document.getElementById('competitorAnalysisSection');
      
      // Clear previous content
      strengthsList.innerHTML = '';
      weaknessesList.innerHTML = '';
      opportunitiesList.innerHTML = '';
      threatsList.innerHTML = '';
      
      // Store analysis data
      analysisData = {
        strengths: [],
        weaknesses: [],
        opportunities: [],
        threats: [],
        financialAnalysis: '',
        marketAnalysis: '',
        competitorAnalysis: ''
      };
      
      // Extract strengths
      const strengthsRegex = /[Kk]ekuatan[^:]*:([^]*?)(?=\n[A-Za-z]*:|$)/;
      const strengthsMatch = text.match(strengthsRegex);
      if (strengthsMatch) {
        const strengths = strengthsMatch[1].trim().split(/\n-|\n\*|\n•/).filter(s => s.trim());
        strengths.forEach(s => {
          if (s.trim()) {
            const li = document.createElement('li');
            li.textContent = s.trim();
            strengthsList.appendChild(li);
            analysisData.strengths.push(s.trim());
          }
        });
      }
      
      // Extract weaknesses
      const weaknessesRegex = /[Kk]elemahan[^:]*:([^]*?)(?=\n[A-Za-z]*:|$)/;
      const weaknessesMatch = text.match(weaknessesRegex);
      if (weaknessesMatch) {
        const weaknesses = weaknessesMatch[1].trim().split(/\n-|\n\*|\n•/).filter(s => s.trim());
        weaknesses.forEach(s => {
          if (s.trim()) {
            const li = document.createElement('li');
            li.textContent = s.trim();
            weaknessesList.appendChild(li);
            analysisData.weaknesses.push(s.trim());
          }
        });
      }
      
      // Extract opportunities
      const opportunitiesRegex = /[Pp]eluang[^:]*:([^]*?)(?=\n[A-Za-z]*:|$)/;
      const opportunitiesMatch = text.match(opportunitiesRegex);
      if (opportunitiesMatch) {
        const opportunities = opportunitiesMatch[1].trim().split(/\n-|\n\*|\n•/).filter(s => s.trim());
        opportunities.forEach(s => {
          if (s.trim()) {
            const li = document.createElement('li');
            li.textContent = s.trim();
            opportunitiesList.appendChild(li);
            analysisData.opportunities.push(s.trim());
          }
        });
      }
      
      // Extract threats
      const threatsRegex = /[Aa]ncaman[^:]*:([^]*?)(?=\n[A-Za-z]*:|$)/;
      const threatsMatch = text.match(threatsRegex);
      if (threatsMatch) {
        const threats = threatsMatch[1].trim().split(/\n-|\n\*|\n•/).filter(s => s.trim());
        threats.forEach(s => {
          if (s.trim()) {
            const li = document.createElement('li');
            li.textContent = s.trim();
            threatsList.appendChild(li);
            analysisData.threats.push(s.trim());
          }
        });
      }
      
      // Extract financial analysis
      const financialRegex = /RENCANA FINANSIAL([^]*?)(?=\n[A-Z\s]{5,}|$)/i;
      const financialMatch = text.match(financialRegex);
      if (financialMatch) {
        const financialContent = financialMatch[1];
        financialAnalysisSection.innerHTML = formatTextWithSections(financialContent);
        analysisData.financialAnalysis = financialContent;
      }
      
      // Extract market analysis
      const marketRegex = /ANALISIS PASAR([^]*?)(?=\n[A-Z\s]{5,}|$)/i;
      const marketMatch = text.match(marketRegex);
      if (marketMatch) {
        const marketContent = marketMatch[1];
        marketAnalysisSection.innerHTML = formatTextWithSections(marketContent);
        analysisData.marketAnalysis = marketContent;
      }
      
      // Extract competitor analysis - look for competitors in text
      const competitorRegex = /[Kk]ompetitor|[Pp]esaing|[Pp]ersaingan([^]*?)(?=\n[A-Z\s]{5,}|$)/i;
      const competitorMatch = text.match(competitorRegex);
      if (competitorMatch) {
        const competitorContent = competitorMatch[1] || competitorMatch[0];
        competitorAnalysisSection.innerHTML = formatTextWithSections(competitorContent);
        analysisData.competitorAnalysis = competitorContent;
      } else {
        // If no dedicated competitor section, extract from market analysis
        competitorAnalysisSection.innerHTML = "<p class='text-gray-500 italic'>Analisis kompetitor secara spesifik tidak ditemukan. Lihat Analisis Pasar untuk informasi terkait persaingan.</p>";
      }
    }
    
    function extractSolutions(text) {
      const shortTermList = document.getElementById('shortTermList');
      const midTermList = document.getElementById('midTermList');
      const longTermList = document.getElementById('longTermList');
      const challengesSection = document.getElementById('challengesSection');
      
      // Clear previous content
      shortTermList.innerHTML = '';
      midTermList.innerHTML = '';
      longTermList.innerHTML = '';
      challengesSection.innerHTML = '';
      
      // Extract short term tasks
      const shortTermTasks = extractTasksByTimeframe(text, /jangka pendek|bulan (1|2|3)|0?[1-3] bulan|tahap awal/i);
      shortTermTasks.forEach(task => {
        const li = document.createElement('li');
        li.textContent = task;
        shortTermList.appendChild(li);
      });
      
      // Extract mid term tasks
      const midTermTasks = extractTasksByTimeframe(text, /jangka menengah|bulan (4|5|6|7|8|9|10|11|12)|[4-9] bulan|10|11|12 bulan|1 tahun/i);
      midTermTasks.forEach(task => {
        const li = document.createElement('li');
        li.textContent = task;
        midTermList.appendChild(li);
      });
      
      // Extract long term tasks
      const longTermTasks = extractTasksByTimeframe(text, /jangka panjang|tahun (1|2|3)|[1-3] tahun|ekspansi/i);
      longTermTasks.forEach(task => {
        const li = document.createElement('li');
        li.textContent = task;
        longTermList.appendChild(li);
      });
      
      // Extract challenges and solutions
      const challengesRegex = /ANALISIS RISIKO([^]*?)(?=\n[A-Z\s]{5,}|$)/i;
      const challengesMatch = text.match(challengesRegex);
      if (challengesMatch) {
        challengesSection.innerHTML = formatTextWithSections(challengesMatch[1]);
      }
    }
    
    function extractTasksByTimeframe(text, timeframeRegex) {
      const tasks = [];
      const lines = text.split('\n');
      
      let isInTimeframeSection = false;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        if (timeframeRegex.test(line)) {
          isInTimeframeSection = true;
          continue;
        }
        
        if (isInTimeframeSection) {
          // If we find another timeframe or major section, stop
          if (/jangka|bulan|tahun|tahap|ANALISIS|RENCANA|STRATEGI|ROADMAP|SARAN/i.test(line) && !timeframeRegex.test(line)) {
            isInTimeframeSection = false;
            continue;
          }
          
          // Extract tasks (lines starting with bullet points, numbers, or certain verbs)
          if (/^[-*•]\s+(.+)$|^[0-9]+\.\s+(.+)$|^(Lakukan|Buat|Siapkan|Kembangkan|Teliti|Analisis)(.+)$/.test(line)) {
            const taskText = line.replace(/^[-*•0-9.]+\s+/, '').trim();
            if (taskText && taskText.length > 5 && !tasks.includes(taskText)) {
              tasks.push(taskText);
            }
          }
        }
      }
      
      // If no tasks were found in dedicated sections, try to infer from the entire text
      if (tasks.length === 0) {
        const allLines = text.split('\n');
        for (const line of allLines) {
          if (timeframeRegex.test(line) && /[-*•]\s+(.+)$|^[0-9]+\.\s+(.+)$/.test(line)) {
            const taskText = line.replace(/^[-*•0-9.]+\s+/, '').trim();
            if (taskText && taskText.length > 5 && !tasks.includes(taskText)) {
              tasks.push(taskText);
            }
          }
        }
      }
      
      return tasks;
    }
    
    function extractFinancialData(text) {
      // Reset financial data
      financialData = {
        initialCapital: 0,
        monthlyExpense: 0,
        monthlyRevenue: 0,
        bepMonths: 0,
        bepAmount: 0,
        projections: []
      };
      
      // Match for currency values
      const currencyRegex = /Rp\.?\s*([0-9.,]+)|([0-9.,]+)\s*[jJ]uta|([0-9.,]+)\s*[mM]il(yar|iar)|([0-9.,]+)\s*[rR]ibu/g;
      
      // Extract initial capital
      const capitalRegex = /[mM]odal\s+[aA]wal[^:]*:\s*([^]*?)(?=\n|$)/;
      const capitalMatch = text.match(capitalRegex);
      if (capitalMatch) {
        const capitalText = capitalMatch[0];
        const currencyMatch = capitalText.match(currencyRegex);
        if (currencyMatch && currencyMatch.length > 0) {
          financialData.initialCapital = parseCurrencyValue(currencyMatch[0]);
        }
      }
      
      // Extract monthly expense
      const expenseRegex = /[bB]iaya\s+[oO]perasional[^:]*:\s*([^]*?)(?=\n|$)/;
      const expenseMatch = text.match(expenseRegex);
      if (expenseMatch) {
        const expenseText = expenseMatch[0];
        const currencyMatch = expenseText.match(currencyRegex);
        if (currencyMatch && currencyMatch.length > 0) {
          financialData.monthlyExpense = parseCurrencyValue(currencyMatch[0]);
        }
      }
      
      // Extract monthly revenue
      const revenueRegex = /[pP]endapatan[^:]*:\s*([^]*?)(?=\n|$)/;
      const revenueMatch = text.match(revenueRegex);
      if (revenueMatch) {
        const revenueText = revenueMatch[0];
        const currencyMatch = revenueText.match(currencyRegex);
        if (currencyMatch && currencyMatch.length > 0) {
          financialData.monthlyRevenue = parseCurrencyValue(currencyMatch[0]);
        }
      }
      
      // Extract BEP information
      const bepRegex = /[bB]reak[\s-]*[eE]ven[\s-]*[pP]oint|BEP[^:]*:\s*([^]*?)(?=\n|$)/;
      const bepMatch = text.match(bepRegex);
      if (bepMatch) {
        const bepText = bepMatch[0];
        
        // Try to find months
        const monthsRegex = /(\d+)[\s-]*(bulan|month)/i;
        const monthsMatch = bepText.match(monthsRegex);
        if (monthsMatch) {
          financialData.bepMonths = parseInt(monthsMatch[1], 10);
        }
        
        // Try to find amount
        const currencyMatch = bepText.match(currencyRegex);
        if (currencyMatch && currencyMatch.length > 0) {
          financialData.bepAmount = parseCurrencyValue(currencyMatch[0]);
        }
      }
      
      // Generate projections for 12 months based on available data
      if (financialData.initialCapital > 0 && financialData.monthlyRevenue > 0) {
        let cumulativeProfit = -financialData.initialCapital;
        
        for (let i = 1; i <= 12; i++) {
          const monthlyProfit = financialData.monthlyRevenue - financialData.monthlyExpense;
          cumulativeProfit += monthlyProfit;
          
          financialData.projections.push({
            month: i,
            revenue: financialData.monthlyRevenue,
            expense: financialData.monthlyExpense,
            profit: monthlyProfit,
            cumulativeProfit: cumulativeProfit
          });
        }
      }
      
      // Update UI with financial data
      document.getElementById('initialCapital').textContent = formatCurrency(financialData.initialCapital);
      document.getElementById('monthlyExpense').textContent = formatCurrency(financialData.monthlyExpense);
      document.getElementById('monthlyRevenue').textContent = formatCurrency(financialData.monthlyRevenue);
      
      if (financialData.bepMonths > 0) {
        document.getElementById('bepTime').textContent = `${financialData.bepMonths} bulan`;
      } else {
        document.getElementById('bepTime').textContent = '-';
      }
      
      if (financialData.bepAmount > 0) {
        document.getElementById('bepAmount').textContent = formatCurrency(financialData.bepAmount);
      } else {
        document.getElementById('bepAmount').textContent = '-';
      }
      
      // Set financial details
      document.getElementById('financialDetails').innerHTML = 
        formatTextWithSections(extractFinancialDetails(text));
    }
    
    function extractFinancialDetails(text) {
      const financialRegex = /RENCANA FINANSIAL([^]*?)(?=\n[A-Z\s]{5,}|$)/i;
      const financialMatch = text.match(financialRegex);
      if (financialMatch) {
        return financialMatch[1];
      }
      return '';
    }
    
    function parseCurrencyValue(currencyStr) {
      // Convert a string representation of currency to a number
      // Handle formats like "Rp 5.000.000", "5 juta", "1,5 milyar", etc.
      
      let value = 0;
      
      // Remove Rp, dots, and convert comma to dot for decimal
      const cleanedStr = currencyStr.replace(/Rp\.?\s*/, '').replace(/\./g, '').replace(/,/g, '.');
      
      if (/juta/i.test(currencyStr)) {
        const number = parseFloat(cleanedStr);
        value = number * 1000000;
      } else if (/mil(yar|iar)/i.test(currencyStr)) {
        const number = parseFloat(cleanedStr);
        value = number * 1000000000;
      } else if (/ribu/i.test(currencyStr)) {
        const number = parseFloat(cleanedStr);
        value = number * 1000;
      } else {
        value = parseFloat(cleanedStr);
      }
      
      return isNaN(value) ? 0 : value;
    }
    
    function formatCurrency(amount) {
      // Format a number as Indonesian currency
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount);
    }
    
    function initializeFinancialCharts() {
      // Destroy previous charts if they exist
      if (revenueChart) {
        revenueChart.destroy();
      }
      if (bepChart) {
        bepChart.destroy();
      }
      
      const months = Array.from({length: 12}, (_, i) => `Bulan ${i+1}`);
      
      // Create revenue & expense chart
      const revenueCtx = document.getElementById('revenueChart').getContext('2d');
      revenueChart = new Chart(revenueCtx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [
            {
              label: 'Pendapatan',
              data: financialData.projections.map(p => p.revenue),
              backgroundColor: 'rgba(16, 185, 129, 0.5)',
              borderColor: 'rgb(16, 185, 129)',
              borderWidth: 1
            },
            {
              label: 'Biaya',
              data: financialData.projections.map(p => p.expense),
              backgroundColor: 'rgba(239, 68, 68, 0.5)',
              borderColor: 'rgb(239, 68, 68)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return (value / 1000000) + ' jt';
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                }
              }
            }
          }
        }
      });
      
      // Create BEP chart (cumulative profit/loss)
      const bepCtx = document.getElementById('bepChart').getContext('2d');
      bepChart = new Chart(bepCtx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [{
            label: 'Keuntungan/Kerugian Kumulatif',
            data: financialData.projections.map(p => p.cumulativeProfit),
            fill: {
              target: 'origin',
              above: 'rgba(16, 185, 129, 0.1)',
              below: 'rgba(239, 68, 68, 0.1)'
            },
            borderColor: function(context) {
              const chart = context.chart;
              const {ctx, chartArea} = chart;
              if (!chartArea) {
                // This could happen when the chart is not yet rendered
                return 'rgb(37, 99, 235)';
              }
              
              // Create gradient based on the data
              const gradientBg = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
              gradientBg.addColorStop(0.5, 'rgb(239, 68, 68)'); // red for negative
              gradientBg.addColorStop(0.5, 'rgb(16, 185, 129)'); // green for positive
              return gradientBg;
            },
            borderWidth: 2,
            tension: 0.1,
            pointBackgroundColor: function(context) {
              const value = context.raw;
              return value < 0 ? 'rgb(239, 68, 68)' : 'rgb(16, 185, 129)';
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              ticks: {
                callback: function(value) {
                  return (value / 1000000) + ' jt';
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  const label = value >= 0 ? 'Keuntungan: ' : 'Kerugian: ';
                  return label + formatCurrency(Math.abs(value));
                },
                title: function(context) {
                  return context[0].label;
                }
              }
            }
          }
        }
      });
    }
    
    async function analyzeCheckedTasks() {
      // Get all checked tasks
      const checkedTasks = allTasks.filter(t => t.completed);
      
      if (checkedTasks.length === 0) {
        showToast('Pilih minimal satu tugas untuk dianalisis', 'fa-exclamation-circle', 'text-yellow-500');
        return;
      }
      
      // Show loading in the analysis area
      const taskAnalysisResult = document.getElementById('taskAnalysisResult');
      const taskAnalysisContent = document.getElementById('taskAnalysisContent');
      
      taskAnalysisResult.classList.remove('hidden');
      taskAnalysisContent.innerHTML = `
        <div class="flex items-center justify-center py-4">
          <div class="thinking-animation h-8 w-8 rounded-full mr-3 flex items-center justify-center">
            <i class="fas fa-brain text-primary text-sm"></i>
          </div>
          <p class="text-primary">Menganalisis tugas-tugas terpilih...</p>
        </div>
      `;
      
      try {
        // Get the task texts
        const taskTexts = checkedTasks.map(t => t.text).join('\n- ');
        
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer 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'
          },
          body: JSON.stringify({
            model: 'meta-llama/llama-4-scout-17b-16e-instruct',
            messages: [
              { 
                role: 'system', 
                content: `Kamu adalah Plant Agent AI, perencana usaha cerdas yang membantu menganalisis pelaksanaan rencana bisnis.
                
                Analisis daftar tugas yang sudah diselesaikan oleh pengguna, dan berikan:
                1. Implikasi positif dari penyelesaian tugas-tugas tersebut
                2. Saran langkah berikutnya yang sebaiknya dikerjakan
                3. Potensi risiko yang bisa dihindari
                4. Tips untuk meningkatkan efektivitas
                
                Jawaban singkat namun mendalam, sekitar 3-4 paragraf.`
              },
              { 
                role: 'user', 
                content: `Berikut adalah daftar tugas yang sudah saya selesaikan dari rencana bisnis:
                
                - ${taskTexts}
                
                Tolong analisis dan berikan saran langkah selanjutnya.`
              }
            ],
            temperature: 0.7,
            top_p: 1,
            max_completion_tokens: 1024,
            stream: false
          })
        });
        
        const data = await response.json();
        const analysisReply = data.choices[0].message.content;
        
        // Display the analysis result
        taskAnalysisContent.innerHTML = formatTextWithSections(analysisReply);
        
      } catch (error) {
        console.error('Error analyzing tasks:', error);
        taskAnalysisContent.innerHTML = `
          <div class="text-red-500">
            <p>Terjadi kesalahan saat menganalisis tugas. Silakan coba lagi nanti.</p>
          </div>
        `;
      }
    }
    
    async function requestDeepAnalysis() {
      // Request a deeper analysis of the business plan
      const idea = document.getElementById('idea').value.trim();
      if (!idea || !latestPlan) {
        showToast('Tidak ada rencana bisnis untuk dianalisis', 'fa-exclamation-circle', 'text-yellow-500');
        return;
      }
      
      // Show loading
      showToast('Memproses analisis mendalam...', 'fa-spinner fa-spin', 'text-blue-500');
      
      try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer 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'
          },
          body: JSON.stringify({
            model: 'meta-llama/llama-4-scout-17b-16e-instruct',
            messages: [
              { 
                role: 'system', 
                content: `Kamu adalah Plant Agent AI, perencana usaha cerdas yang mampu memberikan analisis mendalam.
                
                Berikan analisis mendalam dan lebih detail untuk rencana bisnis yang sudah dibuat. Fokus pada:
                1. Analisis SWOT yang lebih detail
                2. Analisis kompetitor yang lebih spesifik
                3. Detail analisis finansial yang lebih mendalam
                4. Strategi pemasaran yang lebih taktis
                
                Format respons sebagai JSON dengan struktur:
                {
                  "swot": {
                    "strengths": ["strength1", "strength2", ...],
                    "weaknesses": ["weakness1", "weakness2", ...],
                    "opportunities": ["opportunity1", "opportunity2", ...],
                    "threats": ["threat1", "threat2", ...]
                  },
                  "competitorAnalysis": "detailed analysis text",
                  "financialInsights": "detailed financial insights text",
                  "marketingTactics": "detailed marketing tactics text"
                }`
              },
              { 
                role: 'user', 
                content: `Berikut adalah ide bisnis saya:
                
                ${idea}
                
                Dan berikut rencana bisnis yang telah dibuat:
                
                ${latestPlan}
                
                Tolong berikan analisis yang lebih mendalam.`
              }
            ],
            temperature: 0.7,
            top_p: 1,
            max_completion_tokens: 2048,
            stream: false
          })
        });
        
        const data = await response.json();
        const analysisReply = data.choices[0].message.content;
        
        try {
          // Try to parse as JSON
          const analysisData = JSON.parse(analysisReply);
          
          // Update SWOT lists
          updateSwotLists(analysisData.swot);
          
          // Update competitor analysis
          if (analysisData.competitorAnalysis) {
            document.getElementById('competitorAnalysisSection').innerHTML = 
              formatTextWithSections(analysisData.competitorAnalysis);
          }
          
          // Update financial insights
          if (analysisData.financialInsights) {
            document.getElementById('financialAnalysisSection').innerHTML = 
              formatTextWithSections(analysisData.financialInsights);
          }
          
          // Update market analysis with marketing tactics
          if (analysisData.marketingTactics) {
            document.getElementById('marketAnalysisSection').innerHTML = 
              formatTextWithSections(analysisData.marketingTactics);
          }
          
          // Switch to analysis tab
          switchTab('analysis');
          
          showToast('Analisis mendalam telah selesai!', 'fa-check-circle', 'text-green-500');
          
        } catch (jsonError) {
          // If not valid JSON, just use the text and show in analysis tab
          console.error('Response not in expected JSON format:', jsonError);
          
          // Extract sections manually
          const sections = extractSectionsFromText(analysisReply);
          
          // Update SWOT if found
          if (sections.strengths.length > 0) {
            updateSwotLists({
              strengths: sections.strengths,
              weaknesses: sections.weaknesses,
              opportunities: sections.opportunities,
              threats: sections.threats
            });
          }
          
          // Update other sections
          if (sections.competitorAnalysis) {
            document.getElementById('competitorAnalysisSection').innerHTML = 
              formatTextWithSections(sections.competitorAnalysis);
          }
          
          if (sections.financialAnalysis) {
            document.getElementById('financialAnalysisSection').innerHTML = 
              formatTextWithSections(sections.financialAnalysis);
          }
          
          if (sections.marketAnalysis) {
            document.getElementById('marketAnalysisSection').innerHTML = 
              formatTextWithSections(sections.marketAnalysis);
          }
          
          // Switch to analysis tab
          switchTab('analysis');
          
          showToast('Analisis mendalam telah selesai!', 'fa-check-circle', 'text-green-500');
        }
        
      } catch (error) {
        console.error('Error requesting deep analysis:', error);
        showToast('Terjadi kesalahan saat menganalisis. Silakan coba lagi.', 'fa-exclamation-triangle', 'text-red-500');
      }
    }
    
    function updateSwotLists(swot) {
      // Update SWOT lists with new data
      if (!swot) return;
      
      const strengthsList = document.getElementById('strengthsList');
      const weaknessesList = document.getElementById('weaknessesList');
      const opportunitiesList = document.getElementById('opportunitiesList');
      const threatsList = document.getElementById('threatsList');
      
      // Clear previous content
      strengthsList.innerHTML = '';
      weaknessesList.innerHTML = '';
      opportunitiesList.innerHTML = '';
      threatsList.innerHTML = '';
      
      // Update strengths
      if (swot.strengths && swot.strengths.length > 0) {
        swot.strengths.forEach(strength => {
          const li = document.createElement('li');
          li.textContent = strength;
          strengthsList.appendChild(li);
        });
      }
      
      // Update weaknesses
      if (swot.weaknesses && swot.weaknesses.length > 0) {
        swot.weaknesses.forEach(weakness => {
          const li = document.createElement('li');
          li.textContent = weakness;
          weaknessesList.appendChild(li);
        });
      }
      
      // Update opportunities
      if (swot.opportunities && swot.opportunities.length > 0) {
        swot.opportunities.forEach(opportunity => {
          const li = document.createElement('li');
          li.textContent = opportunity;
          opportunitiesList.appendChild(li);
        });
      }
      
      // Update threats
      if (swot.threats && swot.threats.length > 0) {
        swot.threats.forEach(threat => {
          const li = document.createElement('li');
          li.textContent = threat;
          threatsList.appendChild(li);
        });
      }
    }
    
    function extractSectionsFromText(text) {
      // Extract sections from text format when JSON parsing fails
      const sections = {
        strengths: [],
        weaknesses: [],
        opportunities: [],
        threats: [],
        competitorAnalysis: '',
        financialAnalysis: '',
        marketAnalysis: ''
      };
      
      // Extract SWOT
      const strengthsRegex = /[Kk]ekuatan|[Ss]trengths[^:]*:([^]*?)(?=\n[A-Za-z]*:|$)/;
      const strengthsMatch = text.match(strengthsRegex);
      if (strengthsMatch) {
        const strengths = strengthsMatch[1].trim().split(/\n-|\n\*|\n•/).filter(s => s.trim());
        sections.strengths = strengths.map(s => s.trim());
      }
      
      const weaknessesRegex = /[Kk]elemahan|[Ww]eaknesses[^:]*:([^]*?)(?=\n[A-Za-z]*:|$)/;
      const weaknessesMatch = text.match(weaknessesRegex);
      if (weaknessesMatch) {
        const weaknesses = weaknessesMatch[1].trim().split(/\n-|\n\*|\n•/).filter(s => s.trim());
        sections.weaknesses = weaknesses.map(s => s.trim());
      }
      
      const opportunitiesRegex = /[Pp]eluang|[Oo]pportunities[^:]*:([^]*?)(?=\n[A-Za-z]*:|$)/;
      const opportunitiesMatch = text.match(opportunitiesRegex);
      if (opportunitiesMatch) {
        const opportunities = opportunitiesMatch[1].trim().split(/\n-|\n\*|\n•/).filter(s => s.trim());
        sections.opportunities = opportunities.map(s => s.trim());
      }
      
      const threatsRegex = /[Aa]ncaman|[Tt]hreats[^:]*:([^]*?)(?=\n[A-Za-z]*:|$)/;
      const threatsMatch = text.match(threatsRegex);
      if (threatsMatch) {
        const threats = threatsMatch[1].trim().split(/\n-|\n\*|\n•/).filter(s => s.trim());
        sections.threats = threats.map(s => s.trim());
      }
      
      // Extract competitor analysis
      const competitorRegex = /[Aa]nalisis [Kk]ompetitor|[Cc]ompetitor [Aa]nalysis([^]*?)(?=\n[A-Z\s]{5,}|$)/i;
      const competitorMatch = text.match(competitorRegex);
      if (competitorMatch) {
        sections.competitorAnalysis = competitorMatch[1] || competitorMatch[0];
      }
      
      // Extract financial analysis
      const financialRegex = /[Aa]nalisis [Ff]inansial|[Ff]inancial [Aa]nalysis([^]*?)(?=\n[A-Z\s]{5,}|$)/i;
      const financialMatch = text.match(financialRegex);
      if (financialMatch) {
        sections.financialAnalysis = financialMatch[1] || financialMatch[0];
      }
      
      // Extract market analysis
      const marketRegex = /[Aa]nalisis [Pp]asar|[Mm]arket [Aa]nalysis|[Ss]trategi [Pp]emasaran|[Mm]arketing [Ss]trategy([^]*?)(?=\n[A-Z\s]{5,}|$)/i;
      const marketMatch = text.match(marketRegex);
      if (marketMatch) {
        sections.marketAnalysis = marketMatch[1] || marketMatch[0];
      }
      
      return sections;
    }
    
    function saveToLocal() {
      if (latestPlan) {
        const planTitle = extractBusinessTitle(latestPlan);
        const planData = {
          title: planTitle,
          idea: document.getElementById('idea').value.trim(),
          fullPlan: latestPlan,
          tasks: allTasks,
          financialData: financialData,
          analysisData: analysisData,
          dateCreated: new Date().toISOString(),
          id: 'plan_' + Date.now()
        };
        
        // Load existing plans
        const existingPlansJson = localStorage.getItem('plant_agent_plans');
        let existingPlans = [];
        if (existingPlansJson) {
          try {
            existingPlans = JSON.parse(existingPlansJson);
          } catch (e) {
            console.error('Error parsing saved plans:', e);
          }
        }
        
        // Add new plan
        existingPlans.push(planData);
        
        // Save back to localStorage
        localStorage.setItem('plant_agent_plans', JSON.stringify(existingPlans));
        
        // Update saved plans array
        savedPlans = existingPlans;
        
        // Update history panel if open
        if (!document.getElementById('historyPanel').classList.contains('hidden')) {
          updateHistoryPanel();
        }
        
        showToast('Rencana berhasil disimpan!', 'fa-check-circle', 'text-green-500');
      } else {
        showToast('Belum ada rencana untuk disimpan.', 'fa-exclamation-circle', 'text-yellow-500');
      }
    }
    
    function extractBusinessTitle(planText) {
      // Extract a title from the business plan text
      const ringkasanMatch = planText.match(/RINGKASAN EKSEKUTIF[^\n]*\n+([^\n]+)/i);
      if (ringkasanMatch && ringkasanMatch[1]) {
        // Limit to first 50 chars
        return ringkasanMatch[1].trim().substring(0, 50) + (ringkasanMatch[1].length > 50 ? '...' : '');
      }
      
      // If no match, try to get first sentence
      const firstSentence = planText.split(/[.!?]/)[0];
      if (firstSentence && firstSentence.length > 10) {
        return firstSentence.trim().substring(0, 50) + (firstSentence.length > 50 ? '...' : '');
      }
      
      // Fallback
      return 'Rencana Bisnis ' + new Date().toLocaleDateString('id-ID');
    }
    
    function toggleHistoryPanel() {
      const historyPanel = document.getElementById('historyPanel');
      
      if (historyPanel.classList.contains('hidden')) {
        // Show panel and load history
        historyPanel.classList.remove('hidden');
        updateHistoryPanel();
      } else {
        // Hide panel
        historyPanel.classList.add('hidden');
      }
    }
    
    function updateHistoryPanel() {
      const historyList = document.getElementById('historyList');
      const noHistoryMessage = document.getElementById('noHistoryMessage');
      
      // Clear current list
      historyList.innerHTML = '';
      
      // Load saved plans
      const savedPlansJson = localStorage.getItem('plant_agent_plans');
      if (savedPlansJson) {
        try {
          savedPlans = JSON.parse(savedPlansJson);
          
          if (savedPlans.length > 0) {
            noHistoryMessage.classList.add('hidden');
            
            // Sort by date (newest first)
            savedPlans.sort((a, b) => new Date(b.dateCreated) - new Date(a.dateCreated));
            
            // Add each plan to the list
            savedPlans.forEach(plan => {
              const date = new Date(plan.dateCreated);
              const formattedDate = date.toLocaleDateString('id-ID', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
              });
              const formattedTime = date.toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit'
              });
              
              const historyItem = document.createElement('div');
              historyItem.className = 'history-item bg-white p-4 rounded-lg border border-gray-200 shadow-sm hover:shadow';
              historyItem.innerHTML = `
                <div class="flex justify-between items-start">
                  <h4 class="font-medium text-gray-800">${plan.title || 'Rencana Bisnis'}</h4>
                  <div class="flex space-x-2">
                    <button onclick="loadPlanById('${plan.id}')" class="text-primary hover:text-blue-700">
                      <i class="fas fa-folder-open"></i>
                    </button>
                    <button onclick="deletePlanById('${plan.id}')" class="text-red-500 hover:text-red-700">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                <p class="text-sm text-gray-500 mt-1 line-clamp-2">${plan.idea || ''}</p>
                <div class="flex justify-between items-center mt-2">
                  <span class="text-xs text-gray-400">${formattedDate}, ${formattedTime}</span>
                  <span class="text-xs px-2 py-0.5 bg-blue-50 text-primary rounded-full">
                    ${plan.tasks ? plan.tasks.filter(t => t.completed).length : 0}/${plan.tasks ? plan.tasks.length : 0} tugas
                  </span>
                </div>
              `;
              
              historyList.appendChild(historyItem);
            });
          } else {
            noHistoryMessage.classList.remove('hidden');
          }
        } catch (e) {
          console.error('Error parsing saved plans:', e);
          noHistoryMessage.classList.remove('hidden');
        }
      } else {
        noHistoryMessage.classList.remove('hidden');
      }
    }
    
    function loadPlanById(planId) {
      try {
        // Find the plan in the saved plans
        const plan = savedPlans.find(p => p.id === planId);
        
        if (plan) {
          // Restore the idea
          document.getElementById('idea').value = plan.idea || '';
          
          // Restore the plan
          latestPlan = plan.fullPlan;
          
          // Process the plan
          processPlanResponse(latestPlan);
          
          // Restore financial data if available
          if (plan.financialData) {
            financialData = plan.financialData;
            
            // Update UI with financial data
            document.getElementById('initialCapital').textContent = formatCurrency(financialData.initialCapital);
            document.getElementById('monthlyExpense').textContent = formatCurrency(financialData.monthlyExpense);
            document.getElementById('monthlyRevenue').textContent = formatCurrency(financialData.monthlyRevenue);
            
            if (financialData.bepMonths > 0) {
              document.getElementById('bepTime').textContent = `${financialData.bepMonths} bulan`;
            } else {
              document.getElementById('bepTime').textContent = '-';
            }
            
            if (financialData.bepAmount > 0) {
              document.getElementById('bepAmount').textContent = formatCurrency(financialData.bepAmount);
            } else {
              document.getElementById('bepAmount').textContent = '-';
            }
            
            // Initialize financial charts if data available
            if (financialData.projections.length > 0) {
              initializeFinancialCharts();
            }
          }
          
          // Restore task status if available
          if (plan.tasks) {
            plan.tasks.forEach(savedTask => {
              const taskIndex = allTasks.findIndex(t => t.text === savedTask.text);
              if (taskIndex !== -1) {
                allTasks[taskIndex].completed = savedTask.completed;
                const checkbox = document.querySelector(`#${allTasks[taskIndex].id} input[type="checkbox"]`);
                if (checkbox) {
                  checkbox.checked = savedTask.completed;
                  updateTaskStatus(checkbox, allTasks[taskIndex].id);
                }
              }
            });
          }
          
          // Show the output section
          document.getElementById('outputSection').classList.remove('hidden');
          
          // Hide history panel
          document.getElementById('historyPanel').classList.add('hidden');
          
          showToast('Rencana berhasil dimuat!', 'fa-check-circle', 'text-green-500');
        } else {
          showToast('Rencana tidak ditemukan.', 'fa-exclamation-circle', 'text-yellow-500');
        }
      } catch (error) {
        console.error('Error loading plan:', error);
        showToast('Terjadi kesalahan saat memuat rencana.', 'fa-exclamation-triangle', 'text-red-500');
      }
    }
    
    function deletePlanById(planId) {
      if (confirm('Apakah Anda yakin ingin menghapus rencana ini?')) {
        try {
          // Filter out the plan to delete
          savedPlans = savedPlans.filter(p => p.id !== planId);
          
          // Save back to localStorage
          localStorage.setItem('plant_agent_plans', JSON.stringify(savedPlans));
          
          // Update the history panel
          updateHistoryPanel();
          
          showToast('Rencana berhasil dihapus!', 'fa-trash', 'text-red-500');
        } catch (error) {
          console.error('Error deleting plan:', error);
          showToast('Terjadi kesalahan saat menghapus rencana.', 'fa-exclamation-triangle', 'text-red-500');
        }
      }
    }
    
    function clearAllHistory() {
      if (confirm('Apakah Anda yakin ingin menghapus SEMUA riwayat rencana bisnis?')) {
        try {
          // Clear saved plans
          localStorage.removeItem('plant_agent_plans');
          savedPlans = [];
          
          // Update the history panel
          updateHistoryPanel();
          
          showToast('Semua riwayat rencana berhasil dihapus!', 'fa-trash', 'text-red-500');
        } catch (error) {
          console.error('Error clearing history:', error);
          showToast('Terjadi kesalahan saat menghapus riwayat.', 'fa-exclamation-triangle', 'text-red-500');
        }
      }
    }
    
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const icon = document.getElementById(sectionId + 'Icon');
      
      if (section.classList.contains('expanded-analysis')) {
        section.classList.remove('expanded-analysis');
        section.classList.add('collapsed-analysis');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
      } else {
        section.classList.remove('collapsed-analysis');
        section.classList.add('expanded-analysis');
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
      }
    }
    
    function downloadPDF() {
      showToast('Mempersiapkan dokumen untuk diunduh...', 'fa-file-pdf', 'text-blue-500');
      setTimeout(() => {
        printReport();
      }, 500);
    }
    
    function printReport() {
      window.print();
    }
    
    function shareResults() {
      if (navigator.share) {
        navigator.share({
          title: 'Rencana Bisnis dari Plant Agent AI',
          text: latestPlan
        })
        .catch(error => console.log('Error sharing:', error));
      } else {
        copyToClipboard();
        showToast('Rencana telah disalin ke clipboard. Anda dapat membagikannya secara manual.', 'fa-copy', 'text-blue-500');
      }
    }
    
    function copyToClipboard() {
      if (latestPlan) {
        navigator.clipboard.writeText(latestPlan)
          .then(() => showToast('Rencana bisnis telah disalin ke clipboard!', 'fa-copy', 'text-green-500'))
          .catch(err => {
            console.error('Failed to copy text: ', err);
            showToast('Gagal menyalin teks. Silakan coba lagi.', 'fa-exclamation-triangle', 'text-red-500');
          });
      }
    }
    
    function showToast(message, icon, iconClass) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');
      
      // Set message & icon
      toastMessage.textContent = message;
      toastIcon.className = `fas ${icon} ${iconClass}`;
      
      // Show toast
      toast.classList.add('show');
      
      // Hide after 3 seconds
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    function clearAll() {
      document.getElementById('idea').value = '';
      document.getElementById('outputSection').classList.add('hidden');
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('thinkingProcess').classList.add('hidden');
      document.getElementById('taskAnalysisResult').classList.add('hidden');
      latestPlan = '';
      allTasks = [];
      analysisData = {};
      financialData = {
        initialCapital: 0,
        monthlyExpense: 0,
        monthlyRevenue: 0,
        bepMonths: 0,
        bepAmount: 0,
        projections: []
      };
      
      showToast('Semua data telah direset!', 'fa-eraser', 'text-gray-500');
    }
    
    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
      // Load saved plans
      const savedPlansJson = localStorage.getItem('plant_agent_plans');
      if (savedPlansJson) {
        try {
          savedPlans = JSON.parse(savedPlansJson);
          console.log(`${savedPlans.length} rencana bisnis tersimpan ditemukan.`);
        } catch (e) {
          console.error('Error parsing saved plans:', e);
        }
      }
    });
  </script>
</body>
</html>
